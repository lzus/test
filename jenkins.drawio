<mxfile host="app.diagrams.net" modified="2024-01-06T13:40:47.476Z" agent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" etag="Im8S_pCJryH8myHMIwsD" version="22.1.16" type="github">
  <diagram name="第 1 页" id="0g3aWzYnLtcXMj87QazC">
    <mxGraphModel dx="3435" dy="1695" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="qVIc31OxtEuiZdBQp6vo-1" value="Launcher类" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="254" y="-20" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="qVIc31OxtEuiZdBQp6vo-2" value="remoting" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="124" y="-90" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="qVIc31OxtEuiZdBQp6vo-3" value="main Thread" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="114" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="qVIc31OxtEuiZdBQp6vo-4" value="agent" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="1004" y="-80" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="qVIc31OxtEuiZdBQp6vo-5" value="master" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="994" y="-20" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="qVIc31OxtEuiZdBQp6vo-6" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="434" y="10" as="sourcePoint" />
            <mxPoint x="734" y="10" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="qVIc31OxtEuiZdBQp6vo-7" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;span style=&quot;color:#00627a;&quot;&gt;parseJnlpArguments&lt;/span&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="474" y="-80" width="150" height="30" as="geometry" />
        </mxCell>
        <mxCell id="qVIc31OxtEuiZdBQp6vo-8" value="访问http://127.0.0.1:8080/computer/node1/jenkins-agent.jnlp 获取remoting启动参数" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="424" y="-30" width="250" height="30" as="geometry" />
        </mxCell>
        <mxCell id="qVIc31OxtEuiZdBQp6vo-9" value="Main类&lt;br&gt;createEngine&lt;br&gt;startEngine" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="254" y="90" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="qVIc31OxtEuiZdBQp6vo-10" value="main Thread" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="114" y="105" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="qVIc31OxtEuiZdBQp6vo-11" value="Engine类" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="254" y="200" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="qVIc31OxtEuiZdBQp6vo-12" value="Thread0" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="124" y="220" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="qVIc31OxtEuiZdBQp6vo-13" value="创建线程池pool,&lt;br&gt;做一些workdir的创建初始化工作" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="384" y="120" width="236" height="30" as="geometry" />
        </mxCell>
        <mxCell id="qVIc31OxtEuiZdBQp6vo-14" value="1.创建IOHub,&lt;br&gt;创建selector,并用pool启动两个线程" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="401" y="200" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="qVIc31OxtEuiZdBQp6vo-15" value="2.创建SSLContext" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="444" y="260" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="qVIc31OxtEuiZdBQp6vo-17" value="" style="shape=curlyBracket;whiteSpace=wrap;html=1;rounded=1;labelPosition=left;verticalLabelPosition=middle;align=right;verticalAlign=middle;" parent="1" vertex="1">
          <mxGeometry x="524" y="200" width="20" height="30" as="geometry" />
        </mxCell>
        <mxCell id="qVIc31OxtEuiZdBQp6vo-23" value="IOHub" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="564" y="180" width="70" height="20" as="geometry" />
        </mxCell>
        <mxCell id="qVIc31OxtEuiZdBQp6vo-24" value="pool-thread0" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="754" y="170" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="qVIc31OxtEuiZdBQp6vo-25" value="pool-thread1" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="754" y="223.75" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="qVIc31OxtEuiZdBQp6vo-26" value="IOHub #&amp;nbsp;&lt;span style=&quot;background-color: rgb(255, 255, 255); color: rgb(8, 8, 8); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;IOHubSelectorWatcher&lt;/span&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="550" y="212.5" width="226" height="37.5" as="geometry" />
        </mxCell>
        <mxCell id="qVIc31OxtEuiZdBQp6vo-27" value="" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1049.33" y="700" as="sourcePoint" />
            <mxPoint x="1049.33" y="40" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="qVIc31OxtEuiZdBQp6vo-28" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="364" y="440" as="sourcePoint" />
            <mxPoint x="1024" y="440" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="qVIc31OxtEuiZdBQp6vo-29" value="访问：http://127.0.0.1:8080/tcpSlaveAgentListener/， 获取jenkins的socket端口和公钥，连接协议（JNLP4-connect, ping）" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="554" y="400" width="300" height="30" as="geometry" />
        </mxCell>
        <mxCell id="qVIc31OxtEuiZdBQp6vo-30" value="获取endpoint(jenkins主节点)" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="384" y="390" width="170" height="40" as="geometry" />
        </mxCell>
        <mxCell id="qVIc31OxtEuiZdBQp6vo-31" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="369" y="550" as="sourcePoint" />
            <mxPoint x="5270" y="530" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="qVIc31OxtEuiZdBQp6vo-32" value="根据endpoint信息用SocketChannel打开到master的socket连接" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="388" y="490" width="350" height="45" as="geometry" />
        </mxCell>
        <mxCell id="qVIc31OxtEuiZdBQp6vo-33" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;5.connectTcp&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="284" y="490" width="90" height="25" as="geometry" />
        </mxCell>
        <mxCell id="qVIc31OxtEuiZdBQp6vo-34" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;4.JnlpEndpointResolver.resolver&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="288" y="370" width="240" height="40" as="geometry" />
        </mxCell>
        <mxCell id="qVIc31OxtEuiZdBQp6vo-35" value="3.创建JnlpProtocolHandler预备用于交互数据的处理（采用的是JNLP4-connect, 实现类是JnlpProtocol4Handler&lt;span style=&quot;background-color: initial;&quot;&gt;）&lt;/span&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="284" y="320" width="436" height="30" as="geometry" />
        </mxCell>
        <mxCell id="qVIc31OxtEuiZdBQp6vo-36" value="获取端口后还会发起一个到master:port的socket连接请求，以验证端口的有效性，随即断开连接" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="560" y="450" width="314" height="30" as="geometry" />
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-1" value="" style="endArrow=classic;startArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="450" y="880" as="sourcePoint" />
            <mxPoint x="940" y="880" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-30" value="Socket" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="S4PnsvHIbKOA204sQYgr-1" vertex="1" connectable="0">
          <mxGeometry x="-0.5306" y="1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-2" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;NetworkLayer&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="290" y="850" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-3" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;&lt;pre style=&quot;font-family: &amp;quot;.AppleSystemUIFont&amp;quot;; font-size: 9.8pt;&quot;&gt;AgentProtocolClientFilterLayer&lt;/pre&gt;&lt;/pre&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="70" y="850" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-4" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;ApplicationLayer&lt;/pre&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="-660" y="850" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-5" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;ProtocolLayer&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-400" y="810" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-6" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;ProtocolLayer&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="130" y="810" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-7" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;ProtocolLayer&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="320" y="810" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-8" value="" style="shape=curlyBracket;whiteSpace=wrap;html=1;rounded=1;labelPosition=left;verticalLabelPosition=middle;align=right;verticalAlign=middle;rotation=90;" parent="1" vertex="1">
          <mxGeometry x="-149.37" y="330.63" width="43.13" height="916.25" as="geometry" />
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-9" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;ProtocolStack&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="63" y="720" width="117" height="50" as="geometry" />
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-10" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;AckFilterLayer&lt;/pre&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="-70" y="850" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-11" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;ProtocolLayer&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-630" y="811" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-39" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="360" y="920" as="targetPoint" />
            <mxPoint x="360" y="1050" as="sourcePoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-17" value="IOHub" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="500" y="880" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-18" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;ReadableByteChannel&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="510" y="810.5" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-19" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;WritableByteChannel&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="510" y="840.5" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-20" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;InputStream&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="670" y="810.5" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-21" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;SocketChannel&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="790" y="810.5" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-23" value="包装" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="600" y="840.5" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-24" value="包装" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="750" y="840.5" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-25" value="包装" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="600" y="810.5" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-26" value="包装" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="740" y="810.5" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-27" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;OutputStream&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="650" y="840.5" width="110" height="30" as="geometry" />
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-28" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;SocketChannel&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="790" y="840.5" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-31" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;BIONetworkLayer：&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="450" y="781" width="150" height="29" as="geometry" />
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-32" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;NIONetworkLayer：&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="450" y="920" width="150" height="30" as="geometry" />
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-33" value="in：" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="414" y="810" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-34" value="out：" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="414" y="841" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-35" value="in：" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="410" y="950" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-36" value="out" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="407" y="980" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-37" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;SocketChannel&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="467" y="950" width="126" height="30" as="geometry" />
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-38" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;SocketChannel&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="470" y="980" width="126" height="30" as="geometry" />
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-44" value="&lt;pre style=&quot;border-color: var(--border-color); font-weight: 400; background-color: rgb(255, 255, 255); color: rgb(8, 8, 8); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;Ptr recvHead&lt;/pre&gt;" style="swimlane;fontStyle=1;align=center;verticalAlign=middle;childLayout=stackLayout;horizontal=1;startSize=29;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=0;marginBottom=0;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="294" y="1060" width="210" height="80" as="geometry" />
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-46" value="&lt;font style=&quot;font-size: 12px;&quot;&gt;&lt;font face=&quot;JetBrains Mono, monospace&quot; color=&quot;#080808&quot;&gt;&lt;span style=&quot;background-color: rgb(255, 255, 255);&quot;&gt;layer = networklayer&lt;br&gt;&lt;/span&gt;&lt;/font&gt;nextSend = null&lt;br&gt;nextRecv =&lt;br&gt;&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;" parent="S4PnsvHIbKOA204sQYgr-44" vertex="1">
          <mxGeometry y="29" width="210" height="51" as="geometry" />
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-66" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S4PnsvHIbKOA204sQYgr-47" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="395" y="1150" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-47" value="&lt;pre style=&quot;border-color: var(--border-color); font-weight: 400; background-color: rgb(255, 255, 255); color: rgb(8, 8, 8); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;Ptr sendHead&lt;/pre&gt;" style="swimlane;fontStyle=1;align=center;verticalAlign=middle;childLayout=stackLayout;horizontal=1;startSize=29;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=0;marginBottom=0;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="290" y="1210" width="210" height="80" as="geometry" />
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-48" value="&lt;font style=&quot;font-size: 12px;&quot;&gt;sendHead初始化为recvhead, 如果没有FilterLayer设置，那就和recvhead一样的值&lt;br&gt;&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;" parent="S4PnsvHIbKOA204sQYgr-47" vertex="1">
          <mxGeometry y="29" width="210" height="51" as="geometry" />
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-54" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" parent="1" source="S4PnsvHIbKOA204sQYgr-49" target="S4PnsvHIbKOA204sQYgr-3" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="210" y="930" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-49" value="&lt;pre style=&quot;border-color: var(--border-color); font-weight: 400; background-color: rgb(255, 255, 255); color: rgb(8, 8, 8); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;Ptr&lt;/pre&gt;" style="swimlane;fontStyle=1;align=center;verticalAlign=middle;childLayout=stackLayout;horizontal=1;startSize=29;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=0;marginBottom=0;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="60" y="1060" width="210" height="80" as="geometry" />
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-50" value="&lt;font style=&quot;&quot;&gt;&lt;font style=&quot;&quot; face=&quot;JetBrains Mono, monospace&quot; color=&quot;#080808&quot;&gt;&lt;span style=&quot;background-color: rgb(255, 255, 255);&quot;&gt;layer = FilterLayer1&lt;br&gt;&lt;/span&gt;&lt;/font&gt;nextSend =&amp;nbsp;&lt;br&gt;nextRecv =&lt;br&gt;&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;" parent="S4PnsvHIbKOA204sQYgr-49" vertex="1">
          <mxGeometry y="29" width="210" height="51" as="geometry" />
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-51" value="" style="endArrow=classic;html=1;rounded=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="S4PnsvHIbKOA204sQYgr-49" target="S4PnsvHIbKOA204sQYgr-46" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="75" y="54" as="sourcePoint" />
            <mxPoint x="125" y="54" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-59" value="" style="endArrow=classic;html=1;rounded=0;" parent="S4PnsvHIbKOA204sQYgr-49" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="10" y="70" as="sourcePoint" />
            <mxPoint x="-20" y="70" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-53" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="300" y="1130" as="sourcePoint" />
            <mxPoint x="270" y="1130" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-58" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" parent="1" source="S4PnsvHIbKOA204sQYgr-55" target="S4PnsvHIbKOA204sQYgr-10" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-55" value="&lt;pre style=&quot;border-color: var(--border-color); font-weight: 400; background-color: rgb(255, 255, 255); color: rgb(8, 8, 8); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;Ptr SendHead&lt;/pre&gt;" style="swimlane;fontStyle=1;align=center;verticalAlign=middle;childLayout=stackLayout;horizontal=1;startSize=29;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=0;marginBottom=0;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-170" y="1060" width="210" height="80" as="geometry" />
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-56" value="&lt;font style=&quot;&quot;&gt;&lt;font style=&quot;&quot; face=&quot;JetBrains Mono, monospace&quot; color=&quot;#080808&quot;&gt;&lt;span style=&quot;background-color: rgb(255, 255, 255);&quot;&gt;layer = FilterLayer2&lt;br&gt;&lt;/span&gt;&lt;/font&gt;nextSend =&amp;nbsp;&lt;br&gt;nextRecv =&lt;br&gt;&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;" parent="S4PnsvHIbKOA204sQYgr-55" vertex="1">
          <mxGeometry y="29" width="210" height="51" as="geometry" />
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-57" value="" style="endArrow=classic;html=1;rounded=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="S4PnsvHIbKOA204sQYgr-55" target="S4PnsvHIbKOA204sQYgr-50" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="75" y="54" as="sourcePoint" />
            <mxPoint x="125" y="54" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-64" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="S4PnsvHIbKOA204sQYgr-60" target="S4PnsvHIbKOA204sQYgr-4" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-295" y="1000" />
              <mxPoint x="-600" y="1000" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-60" value="&lt;pre style=&quot;border-color: var(--border-color); font-weight: 400; background-color: rgb(255, 255, 255); color: rgb(8, 8, 8); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;Ptr &lt;/pre&gt;" style="swimlane;fontStyle=1;align=center;verticalAlign=middle;childLayout=stackLayout;horizontal=1;startSize=29;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=0;marginBottom=0;html=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-400" y="1060" width="210" height="80" as="geometry" />
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-61" value="&lt;font style=&quot;&quot;&gt;&lt;font style=&quot;&quot; face=&quot;JetBrains Mono, monospace&quot; color=&quot;#080808&quot;&gt;&lt;span style=&quot;background-color: rgb(255, 255, 255);&quot;&gt;layer = ApplicationLayer&lt;br&gt;&lt;/span&gt;&lt;/font&gt;nextSend =&amp;nbsp;&lt;br&gt;nextRecv = null&lt;br&gt;&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;" parent="S4PnsvHIbKOA204sQYgr-60" vertex="1">
          <mxGeometry y="29" width="210" height="51" as="geometry" />
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-62" value="" style="endArrow=classic;html=1;rounded=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="S4PnsvHIbKOA204sQYgr-60" target="S4PnsvHIbKOA204sQYgr-56" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="75" y="54" as="sourcePoint" />
            <mxPoint x="125" y="54" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="S4PnsvHIbKOA204sQYgr-65" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-160" y="1130" as="sourcePoint" />
            <mxPoint x="-190" y="1130" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="LlYnxhrn1TKEqOn0lMnf-1" value="&lt;font color=&quot;#6666ff&quot;&gt;while(IOHub.isOpen()&lt;span style=&quot;background-color: initial;&quot;&gt;)轮询selector, 如果有事件，取出IOHubReadyListener线程对象，&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;用线程池pool去运行&lt;/span&gt;&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="864" y="175" width="150" height="30" as="geometry" />
        </mxCell>
        <mxCell id="LlYnxhrn1TKEqOn0lMnf-2" value="&lt;font color=&quot;#6666ff&quot;&gt;只是起到selector wakeup的作用&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="854" y="240" width="130" height="30" as="geometry" />
        </mxCell>
        <mxCell id="FhYZfcETigPhw3zmsrr1-1" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;SSLEngineFilterLayer&lt;/pre&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="-250" y="850" width="160" height="60" as="geometry" />
        </mxCell>
        <mxCell id="FhYZfcETigPhw3zmsrr1-2" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;ConnectionHeadersFilterLayer&lt;/pre&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="-490" y="850" width="230" height="60" as="geometry" />
        </mxCell>
        <mxCell id="FhYZfcETigPhw3zmsrr1-3" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;pre style=&quot;font-family: &amp;quot;.AppleSystemUIFont&amp;quot;; font-size: 9.8pt;&quot;&gt;BIONetworkLayer&lt;/pre&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="-105" y="1460" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="FhYZfcETigPhw3zmsrr1-4" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="60" y="1500" as="sourcePoint" />
            <mxPoint x="150" y="1500" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="FhYZfcETigPhw3zmsrr1-6" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;getIoHub().execute(reader)&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="170" y="1475" width="210" height="45" as="geometry" />
        </mxCell>
        <mxCell id="FhYZfcETigPhw3zmsrr1-7" value="新线程读数据" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="160" y="1500" width="110" height="30" as="geometry" />
        </mxCell>
        <mxCell id="FhYZfcETigPhw3zmsrr1-8" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="404" y="1497" as="sourcePoint" />
            <mxPoint x="464" y="1497" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="FhYZfcETigPhw3zmsrr1-9" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;等待启动完成ProtocolStack.&lt;span style=&quot;color:#00627a;font-style:italic;&quot;&gt;waitForStart&lt;/span&gt;()&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="480" y="1483" width="270" height="37" as="geometry" />
        </mxCell>
        <mxCell id="FhYZfcETigPhw3zmsrr1-10" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;.AppleSystemUIFont&#39;;font-size:9.8pt;&quot;&gt;AgentProtocolClientFilterLayer&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="-170" y="1650" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="FhYZfcETigPhw3zmsrr1-11" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="65" y="1690" as="sourcePoint" />
            <mxPoint x="155" y="1690" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="FhYZfcETigPhw3zmsrr1-13" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;getIoHub().execute(writer)&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="170" y="1520" width="210" height="45" as="geometry" />
        </mxCell>
        <mxCell id="FhYZfcETigPhw3zmsrr1-16" value="&lt;pre style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;创建一个writequeue: ByteBufferQueue包含new ByteBuffer[&lt;font style=&quot;font-size: 9.8pt;&quot; color=&quot;#871094&quot;&gt;&lt;i&gt;16&lt;/i&gt;&lt;/font&gt;&lt;font style=&quot;font-size: 9.8pt;&quot; color=&quot;#080808&quot;&gt;]， 每个8192字节，&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;&lt;font style=&quot;font-size: 9.8pt;&quot; color=&quot;#080808&quot;&gt;client发送的内容都会写到这个writequeue来发送;&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;创建一个recvqueue ByteBufferQueue用来写入接收的数据；&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;创建一个sendqueue：ByteBufferQueue也是用于发送数据（最终还是写入writequeue来发送）；&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="150" y="1370" width="698" height="90" as="geometry" />
        </mxCell>
        <mxCell id="FhYZfcETigPhw3zmsrr1-17" value="&lt;pre style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;创建一个sendqueue:ByteBufferQueue包含new ByteBuffer[&lt;font style=&quot;font-size: 9.8pt;&quot; color=&quot;#871094&quot;&gt;&lt;i&gt;16&lt;/i&gt;&lt;/font&gt;&lt;font style=&quot;font-size: 9.8pt;&quot; color=&quot;#080808&quot;&gt;]， &lt;/font&gt;每个8192字节，用于发送数据， &lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;经由此层发送的数据，附加到sendqueue中进行发送；&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;启动开始发送&quot;Protocol:JNLP4-connect&quot;&lt;span style=&quot;color: rgb(8, 8, 8); font-size: 9.8pt;&quot;&gt;；-- 24字节==2字节长度+22字节串&lt;/span&gt;&lt;/pre&gt;&lt;font face=&quot;JetBrains Mono, monospace&quot; color=&quot;#080808&quot;&gt;&lt;/font&gt;&lt;pre style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;&lt;font style=&quot;font-size: 9.8pt;&quot; color=&quot;#080808&quot;&gt;接收的数据不处理，直接交给下一层，所以没有recv queue相关属性&lt;/font&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="185" y="1630" width="740" height="90" as="geometry" />
        </mxCell>
        <mxCell id="tP1lmiw2_yDiyHUFnw0z-1" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;.AppleSystemUIFont&#39;;font-size:9.8pt;&quot;&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;AckFilterLayer&lt;/pre&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="-185" y="1850" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="tP1lmiw2_yDiyHUFnw0z-2" value="&lt;pre style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;创建一个sendqueue:ByteBufferQueue包含new ByteBuffer[&lt;font style=&quot;font-size: 9.8pt;&quot; color=&quot;#871094&quot;&gt;&lt;i&gt;16&lt;/i&gt;&lt;/font&gt;&lt;font style=&quot;font-size: 9.8pt;&quot; color=&quot;#080808&quot;&gt;]， &lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;&lt;font style=&quot;font-size: 9.8pt;&quot; color=&quot;#080808&quot;&gt;每个8192字节，用于发送数据， 经由此层发送的数据，附加到sendqueue中进行发送；&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;&lt;pre style=&quot;border-color: var(--border-color); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;启动开始发送&quot;ACK&quot;；-- 5字节==2字节长度+3字节字符串&lt;/pre&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;创建一个recvqueue:ByteBufferQueue&lt;font style=&quot;font-size: 9.8pt;&quot; color=&quot;#080808&quot;&gt;接收的数据附加到这个queue中&lt;/font&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="130" y="1820" width="569" height="90" as="geometry" />
        </mxCell>
        <mxCell id="tP1lmiw2_yDiyHUFnw0z-3" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="30" y="1879" as="sourcePoint" />
            <mxPoint x="120" y="1879" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="tP1lmiw2_yDiyHUFnw0z-4" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;.AppleSystemUIFont&#39;;font-size:9.8pt;&quot;&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;SSLEngineFilterLayer&lt;/pre&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="-190" y="1990" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="tP1lmiw2_yDiyHUFnw0z-5" value="&lt;pre style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;&lt;pre style=&quot;color: rgb(8, 8, 8); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;执行握手sslEngine.beginHandshake()；&lt;/pre&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;&lt;span style=&quot;color: rgb(8, 8, 8);&quot;&gt;创建ConcurrentLinkedQueue&amp;lt;&lt;span style=&quot;color:#000000;&quot;&gt;ByteBuffer&amp;gt; messages 保存发送的信息；&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;发送时会从message拿出信息，调用sslEngine.wrap()封装信息放到ByteBuffer对象里，再发送；&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;收到信息时会先accumulate在“ByteBuffer previous”，再判断是不是handshake信息，再用sslEngine.unwrap()解封装；&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="155" y="1960" width="570" height="110" as="geometry" />
        </mxCell>
        <mxCell id="tP1lmiw2_yDiyHUFnw0z-6" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="30" y="2019.5" as="sourcePoint" />
            <mxPoint x="120" y="2019.5" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="tP1lmiw2_yDiyHUFnw0z-7" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;ConnectionHeadersFilterLayer&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="-272.8" y="2120" width="290" height="60" as="geometry" />
        </mxCell>
        <mxCell id="tP1lmiw2_yDiyHUFnw0z-8" value="&lt;pre style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;创建一个sendqueue:ByteBufferQueue包含new ByteBuffer[&lt;font style=&quot;font-size: 9.8pt;&quot; color=&quot;#871094&quot;&gt;&lt;i&gt;16&lt;/i&gt;&lt;/font&gt;&lt;font style=&quot;font-size: 9.8pt;&quot; color=&quot;#080808&quot;&gt;]， &lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;&lt;font style=&quot;font-size: 9.8pt;&quot; color=&quot;#080808&quot;&gt;每个8192字节，用于发送数据， 经由此层发送的数据，附加到sendqueue中进行发送；&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;创建一个recvqueue:ByteBufferQueue&lt;font style=&quot;font-size: 9.8pt;&quot; color=&quot;#080808&quot;&gt;接收的数据附加到这个queue中&lt;/font&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="182.5" y="2090" width="569" height="90" as="geometry" />
        </mxCell>
        <mxCell id="tP1lmiw2_yDiyHUFnw0z-9" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="40" y="2150" as="sourcePoint" />
            <mxPoint x="130" y="2150" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="tP1lmiw2_yDiyHUFnw0z-10" value="问题： 在发送和接收数据时，如何保证当前信息是完整的？而不是被分割放到前一条或下一条信息里？" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-550" y="1960" width="290" height="80" as="geometry" />
        </mxCell>
        <mxCell id="tP1lmiw2_yDiyHUFnw0z-12" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;ProtocolStack&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;dashed=1;" parent="1" vertex="1">
          <mxGeometry x="-240" y="2320" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="tP1lmiw2_yDiyHUFnw0z-13" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-60" y="2360" as="sourcePoint" />
            <mxPoint x="160" y="2360" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="tP1lmiw2_yDiyHUFnw0z-14" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;span style=&quot;color:#000000;&quot;&gt;ProtocolStack.init()结束时才调用&lt;/span&gt;awaitStart.countDown(), 此后NetworkLayer才从通道读取返回的数据进行处理&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="60" y="2308" width="460" height="42" as="geometry" />
        </mxCell>
        <mxCell id="62yxdlusjtpypa1GuYyr-1" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;ConnectionHeadersFilterLayer&lt;/pre&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="-690" y="2610" width="230" height="60" as="geometry" />
        </mxCell>
        <mxCell id="62yxdlusjtpypa1GuYyr-2" value="发送数据时，数据的转换过程：" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-710" y="2530" width="220" height="30" as="geometry" />
        </mxCell>
        <mxCell id="62yxdlusjtpypa1GuYyr-3" value="doSend(ByteBuffer data)" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-650" y="2760" width="150" height="30" as="geometry" />
        </mxCell>
        <mxCell id="62yxdlusjtpypa1GuYyr-5" value="" style="endArrow=classic;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-590.5" y="2680" as="sourcePoint" />
            <mxPoint x="-590" y="2730" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="62yxdlusjtpypa1GuYyr-7" value="" style="endArrow=classic;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-590" y="2800" as="sourcePoint" />
            <mxPoint x="-589.5" y="2850" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="62yxdlusjtpypa1GuYyr-8" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;当没finished或者&lt;/pre&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;原先有数据时，先存储&lt;/pre&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;sendQueue.put(data)&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-640" y="2853" width="130" height="70" as="geometry" />
        </mxCell>
        <mxCell id="62yxdlusjtpypa1GuYyr-9" value="sendQueue是一个ByteBuffer[]数组数据类型，每个数组元素ByteBuffer大小定义成8192，sendQueue会保存data参数数据（存储在sendQueue中是连续的，无边界，所以如果往里写的data数据比较大的话，sendQueue会动态申请更多ByteBuffer数组元素去保存，所以data的存储是会跨数组元素存储的）" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-1020" y="2833" width="370" height="90" as="geometry" />
        </mxCell>
        <mxCell id="62yxdlusjtpypa1GuYyr-10" value="" style="endArrow=classic;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-590" y="2950" as="sourcePoint" />
            <mxPoint x="-589" y="3050" as="targetPoint" />
            <Array as="points">
              <mxPoint x="-590" y="2960" />
              <mxPoint x="-589" y="2960" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="62yxdlusjtpypa1GuYyr-11" value="然后循环发送&lt;br&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;ByteBuffer tmp = ByteBuffer.&lt;span style=&quot;font-style:italic;&quot;&gt;allocate&lt;/span&gt;(&lt;span style=&quot;color:#871094;&quot;&gt;8192&lt;/span&gt;)；  //申请一个8192的ByteBuffer tmp&lt;/pre&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;while (sendQueue.hasRemaining()) {&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;&lt;pre style=&quot;color: rgb(8, 8, 8); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;  ((Buffer) &lt;span style=&quot;color:#000000;&quot;&gt;tmp&lt;/span&gt;).clear();&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;&lt;font color=&quot;#080808&quot;&gt;  sendQueue.get(tmp); //&lt;/font&gt;&lt;b style=&quot;&quot;&gt;&lt;font color=&quot;#ff6666&quot;&gt;填满tmp 8192字节&lt;/font&gt;&lt;/b&gt;&lt;font color=&quot;#080808&quot;&gt;，或者不满8192但是sendQueue已经读取完毕&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;color: rgb(8, 8, 8); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;  ptr.doSend(&lt;span style=&quot;color:#000000;&quot;&gt;tmp&lt;/span&gt;); //发送&lt;/pre&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;}&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-690" y="3060" width="610" height="220" as="geometry" />
        </mxCell>
        <mxCell id="62yxdlusjtpypa1GuYyr-12" value="doSend()是上层应用层调用，我们无法预知data的大小，所以借助sendQueue这一动态空间先保存" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-890" y="2760" width="200" height="50" as="geometry" />
        </mxCell>
        <mxCell id="62yxdlusjtpypa1GuYyr-14" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;getNextSend().layer.doSend(tmp)&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-700" y="3300" width="280" height="40" as="geometry" />
        </mxCell>
        <mxCell id="62yxdlusjtpypa1GuYyr-15" value="" style="endArrow=classic;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-575.5" y="3240" as="sourcePoint" />
            <mxPoint x="-575" y="3290" as="targetPoint" />
            <Array as="points">
              <mxPoint x="-575" y="3265" />
              <mxPoint x="-575" y="3265" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="62yxdlusjtpypa1GuYyr-16" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;&lt;pre style=&quot;border-color: var(--border-color); font-size: 9.8pt; font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace;&quot;&gt;SSLEngineFilterLayer&lt;/pre&gt;&lt;/pre&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="205" y="2600" width="230" height="60" as="geometry" />
        </mxCell>
        <mxCell id="62yxdlusjtpypa1GuYyr-17" value="doSend(ByteBuffer&amp;nbsp;message&lt;span style=&quot;background-color: initial;&quot;&gt;)&lt;/span&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="234" y="2710" width="176" height="30" as="geometry" />
        </mxCell>
        <mxCell id="62yxdlusjtpypa1GuYyr-19" value="" style="endArrow=classic;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-570" y="2800" as="sourcePoint" />
            <mxPoint x="-390" y="2890" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="62yxdlusjtpypa1GuYyr-20" value="注意，这里有分叉，当sendQueue原先没数据时，&lt;br&gt;直接调用&lt;span style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;&lt;font color=&quot;#080808&quot;&gt;ptr.doSend(data)， &lt;/font&gt;&lt;b style=&quot;&quot;&gt;&lt;font color=&quot;#ff6666&quot;&gt;data大小未知&lt;/font&gt;&lt;/b&gt;&lt;/span&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-500" y="2872" width="300" height="70" as="geometry" />
        </mxCell>
        <mxCell id="62yxdlusjtpypa1GuYyr-21" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;getNextSend().layer.doSend(data)&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-510" y="2970" width="280" height="40" as="geometry" />
        </mxCell>
        <mxCell id="62yxdlusjtpypa1GuYyr-22" value="" style="endArrow=classic;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-390" y="2930" as="sourcePoint" />
            <mxPoint x="-389.5" y="2980" as="targetPoint" />
            <Array as="points">
              <mxPoint x="-389.5" y="2940" />
              <mxPoint x="-389.5" y="2940" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="62yxdlusjtpypa1GuYyr-24" value="这个ByteBuffer &lt;b&gt;&lt;font color=&quot;#ff6666&quot;&gt;message的大小也是未知的&lt;/font&gt;&lt;/b&gt;，因为tmp的值可能是上一层直接发送的data或上一层self_data， 也有可能是通过ByfeBufferQueue获取的8192字节的tmp; 也有可能是自身的self_data" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="430" y="2700" width="406" height="60" as="geometry" />
        </mxCell>
        <mxCell id="62yxdlusjtpypa1GuYyr-25" value="" style="endArrow=classic;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-390" y="2800" as="sourcePoint" />
            <mxPoint x="-120" y="2870" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="62yxdlusjtpypa1GuYyr-26" value="注意，这里有分叉，这层有自身的数据要发送，&lt;br&gt;直接调用&lt;span style=&quot;background-color: rgb(255, 255, 255); color: rgb(8, 8, 8); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;ptr.doSend(self_data)&lt;/span&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-210" y="2867" width="300" height="70" as="geometry" />
        </mxCell>
        <mxCell id="62yxdlusjtpypa1GuYyr-27" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;getNextSend().layer.doSend(self_data)&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-210" y="2970" width="310" height="40" as="geometry" />
        </mxCell>
        <mxCell id="62yxdlusjtpypa1GuYyr-28" value="" style="endArrow=classic;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-120" y="2930" as="sourcePoint" />
            <mxPoint x="-119.5" y="2980" as="targetPoint" />
            <Array as="points">
              <mxPoint x="-119.5" y="2940" />
              <mxPoint x="-119.5" y="2940" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="62yxdlusjtpypa1GuYyr-29" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;ByteBuffer newBuffer = &lt;span style=&quot;color:#000000;&quot;&gt;ByteBuffer&lt;/span&gt;.&lt;span style=&quot;font-style:italic;&quot;&gt;allocate&lt;/span&gt;(message.remaining() * &lt;span style=&quot;color:#1750eb;&quot;&gt;2&lt;/span&gt;)&lt;/pre&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;pre style=&quot;text-align: left; font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;newBuffer.put(message)&lt;/pre&gt;&lt;pre style=&quot;text-align: left; font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;messages.add(newBuffer). //先存储到ConcurrentLinkedQueue中，FIFO&lt;br&gt;&lt;/pre&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="167" y="2780" width="540" height="87" as="geometry" />
        </mxCell>
        <mxCell id="62yxdlusjtpypa1GuYyr-30" value="" style="endArrow=classic;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="338.5" y="2740" as="sourcePoint" />
            <mxPoint x="338.5" y="2790" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="62yxdlusjtpypa1GuYyr-31" value="分配一个2倍空间存储, 为什么？？" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="715" y="2780" width="210" height="30" as="geometry" />
        </mxCell>
        <mxCell id="62yxdlusjtpypa1GuYyr-32" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;if (&lt;span style=&quot;color:#000000;&quot;&gt;State&lt;/span&gt;.&lt;span style=&quot;color:#871094;font-style:italic;&quot;&gt;CREDENTAILS_AVAILABLE&lt;/span&gt;.equals(&lt;span style=&quot;color:#871094;&quot;&gt;state&lt;/span&gt;)) {  //当不在状态时，不发，这也是存储的原因之一&lt;/pre&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;  while (&lt;span style=&quot;color:#0033b3;&quot;&gt;null &lt;/span&gt;!= (&lt;span style=&quot;color:#000000;&quot;&gt;request &lt;/span&gt;= &lt;span style=&quot;color:#871094;&quot;&gt;messages&lt;/span&gt;.poll())) {  // 一发就从queue中逐条发送完&lt;/pre&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;processWrite(&lt;span style=&quot;font-size: 9.8pt; color: rgb(0, 0, 0);&quot;&gt;ByteBuffer &lt;/span&gt;&lt;span style=&quot;font-size: 9.8pt;&quot;&gt;request)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;  }&lt;/pre&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;}&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="170" y="2872" width="660" height="102" as="geometry" />
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-1" value="&lt;b&gt;&lt;font color=&quot;#ff6666&quot;&gt;所以上一层的ByteBuffer到这一层开头就不再引用，数据已经存储到新ByteBuffer中&lt;/font&gt;&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="707" y="2810" width="275" height="30" as="geometry" />
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-2" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;div style=&quot;text-align: left;&quot;&gt;&lt;span style=&quot;font-size: 9.8pt; white-space: normal;&quot;&gt;final int &lt;/span&gt;&lt;span style=&quot;font-size: 9.8pt; white-space: normal; color: rgb(0, 0, 0);&quot;&gt;packetBufferSize &lt;/span&gt;&lt;span style=&quot;font-size: 9.8pt; white-space: normal;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-size: 9.8pt; white-space: normal; color: rgb(0, 0, 0);&quot;&gt;sslEngine&lt;/span&gt;&lt;span style=&quot;font-size: 9.8pt; white-space: normal;&quot;&gt;.getSession().getPacketBufferSize();&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;// 16709&lt;/span&gt;&lt;/div&gt;&lt;span style=&quot;color:#0033b3;&quot;&gt;final int &lt;/span&gt;&lt;span style=&quot;color:#000000;&quot;&gt;applicationBufferSize &lt;/span&gt;= &lt;span style=&quot;color:#000000;&quot;&gt;sslEngine&lt;/span&gt;.getSession().getApplicationBufferSize();  //16704&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="430" y="2605" width="798" height="50" as="geometry" />
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-3" value="" style="endArrow=classic;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="321.5" y="2965" as="sourcePoint" />
            <mxPoint x="321.5" y="3015" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-4" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;ByteBuffer appBuffer = &lt;span style=&quot;color:#000000;&quot;&gt;ByteBuffer&lt;/span&gt;.&lt;span style=&quot;font-style:italic;&quot;&gt;allocate&lt;/span&gt;(&lt;span style=&quot;color:#871094;&quot;&gt;sslEngine&lt;/span&gt;.getSession().getPacketBufferSize());&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;&lt;font color=&quot;#080808&quot;&gt;SSLEngineResult result = &lt;/font&gt;&lt;span style=&quot;color: rgb(135, 16, 148); font-size: 9.8pt;&quot;&gt;sslEngine&lt;/span&gt;&lt;span style=&quot;color: rgb(8, 8, 8); font-size: 9.8pt;&quot;&gt;.wrap(request, &lt;/span&gt;&lt;span style=&quot;color: rgb(0, 0, 0); font-size: 9.8pt;&quot;&gt;appBuffer&lt;/span&gt;&lt;font color=&quot;#080808&quot;&gt;); // &lt;/font&gt;&lt;b style=&quot;&quot;&gt;&lt;font color=&quot;#ff6666&quot;&gt;request的大小未知&lt;/font&gt;&lt;/b&gt;&lt;font color=&quot;#080808&quot;&gt;，有可能在过appBuffer, &lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255, 255, 255); color: rgb(8, 8, 8); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;                                                      此时在BUFFER_OVERFLOW中要重新分配appBuffer的大小&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255, 255, 255); color: rgb(8, 8, 8); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;while (&lt;span style=&quot;color:#000000;&quot;&gt;appBuffer&lt;/span&gt;.hasRemaining()) { //需要循环说明啥？ ？？&lt;br&gt;    next().doSend(&lt;span style=&quot;color:#000000;&quot;&gt;appBuffer&lt;/span&gt;);&lt;br&gt;}&lt;/pre&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="80" y="3010" width="830" height="150" as="geometry" />
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-5" value="&lt;pre style=&quot;border-color: var(--border-color); color: rgb(8, 8, 8); font-size: 9.8pt; font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace;&quot;&gt;AckFilterLayer&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="2340" y="2570" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-6" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;getNextSend().layer.doSend(appBuffer)&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="114" y="3240" width="280" height="40" as="geometry" />
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-7" value="" style="endArrow=classic;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="234" y="3130" as="sourcePoint" />
            <mxPoint x="235" y="3230" as="targetPoint" />
            <Array as="points">
              <mxPoint x="234.5" y="3155" />
              <mxPoint x="234.5" y="3155" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-8" value="" style="endArrow=classic;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="321.5" y="2660" as="sourcePoint" />
            <mxPoint x="321.5" y="2710" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-9" value="" style="endArrow=classic;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="320" y="2670" as="sourcePoint" />
            <mxPoint x="1140" y="2710" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-10" value="握手过程中，也可以直接发握手数据" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="1051" y="2715" width="190" height="30" as="geometry" />
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-11" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;ByteBuffer appBuffer = &lt;span style=&quot;color:#000000;&quot;&gt;ByteBuffer&lt;/span&gt;.&lt;span style=&quot;font-style:italic;&quot;&gt;allocate&lt;/span&gt;(&lt;span style=&quot;color:#871094;&quot;&gt;sslEngine&lt;/span&gt;.getSession().getPacketBufferSize());&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255, 255, 255); color: rgb(8, 8, 8); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;SSLEngineResult result = &lt;span style=&quot;font-size: 9.8pt; color: rgb(135, 16, 148);&quot;&gt;sslEngine&lt;/span&gt;.wrap(EMPTY_BUFFER, &lt;span style=&quot;font-size: 9.8pt; color: rgb(0, 0, 0);&quot;&gt;appBuffer&lt;/span&gt;); // EMPTY_BUFFER的大小为0，但是是握手，有可能在要发送的超过appBuffer,&amp;nbsp;&lt;br&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255, 255, 255); color: rgb(8, 8, 8); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;                                                      此时在BUFFER_OVERFLOW中要重新分配appBuffer的大小&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255, 255, 255); color: rgb(8, 8, 8); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;&lt;br&gt;next().doSend(&lt;span style=&quot;color:#000000;&quot;&gt;appBuffer&lt;/span&gt;);&lt;br&gt;&lt;br&gt;&lt;/pre&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="1020" y="2813" width="830" height="150" as="geometry" />
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-12" value="" style="endArrow=classic;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1145.5" y="2760" as="sourcePoint" />
            <mxPoint x="1145.5" y="2810" as="targetPoint" />
            <Array as="points">
              <mxPoint x="1146" y="2755" />
              <mxPoint x="1146" y="2755" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-13" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;getNextSend().layer.doSend(appBuffer)&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="1000" y="3030" width="280" height="40" as="geometry" />
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-14" value="" style="endArrow=classic;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1139.5" y="2967.5" as="sourcePoint" />
            <mxPoint x="1139.5" y="3017.5" as="targetPoint" />
            <Array as="points">
              <mxPoint x="1140" y="2962.5" />
              <mxPoint x="1140" y="2962.5" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-15" value="" style="endArrow=classic;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="2390" y="2650" as="sourcePoint" />
            <mxPoint x="2390" y="2710" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-16" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;doSend(&lt;span style=&quot;color:#9e880d;&quot;&gt;@NonNull &lt;/span&gt;&lt;span style=&quot;color:#000000;&quot;&gt;ByteBuffer &lt;/span&gt;data)&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="2280" y="2720" width="270" height="40" as="geometry" />
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-17" value="&lt;pre style=&quot;border-color: var(--border-color); color: rgb(8, 8, 8); font-size: 9.8pt; text-align: left; font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace;&quot;&gt;ConcurrentLinkedQueue保存&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-10" y="2835" width="165" height="37" as="geometry" />
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-18" value="" style="endArrow=classic;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="2320" y="2780" as="sourcePoint" />
            <mxPoint x="2320" y="2880" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-19" value="" style="endArrow=classic;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="2450" y="2780" as="sourcePoint" />
            <mxPoint x="2570" y="2880" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-20" value="当sendQueue有数据时（不止这种条件）先保存到sendQueue中&lt;br&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;sendQueue.put(data);&lt;/pre&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;flushSend(sendQueue);&lt;/pre&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="2190" y="2890" width="210" height="94" as="geometry" />
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-21" value="" style="endArrow=classic;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="2490" y="2770" as="sourcePoint" />
            <mxPoint x="2800" y="2875" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-22" value="当sendQueuue没数据时直接发送&lt;br&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;next().doSend(data)&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="2490" y="2903" width="180" height="37" as="geometry" />
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-24" value="&lt;b&gt;&lt;font color=&quot;#ff6666&quot;&gt;data的大小未知&lt;/font&gt;&lt;/b&gt;， 可能会很大，不止8192(上一层的发送就已经未知大小)" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="2560" y="2725" width="220" height="25" as="geometry" />
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-25" value="发送自身数据next().doSend(&lt;font color=&quot;#871094&quot;&gt;self_data&lt;/font&gt;&lt;span style=&quot;background-color: rgb(255, 255, 255); color: rgb(8, 8, 8); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;)&lt;/span&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="2735" y="2910" width="160" height="30" as="geometry" />
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-26" value="然后循环发送&lt;br&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;ByteBuffer tmp = ByteBuffer.&lt;span style=&quot;font-style:italic;&quot;&gt;allocate&lt;/span&gt;(&lt;span style=&quot;color:#871094;&quot;&gt;8192&lt;/span&gt;)；  //申请一个8192的ByteBuffer tmp&lt;/pre&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;while (sendQueue.hasRemaining()) {&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;&lt;pre style=&quot;color: rgb(8, 8, 8); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;  ((Buffer) &lt;span style=&quot;color:#000000;&quot;&gt;tmp&lt;/span&gt;).clear();&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;&lt;font color=&quot;#080808&quot;&gt;  sendQueue.get(tmp); //&lt;/font&gt;&lt;b style=&quot;&quot;&gt;&lt;font color=&quot;#ff6666&quot;&gt;填满tmp 8192字节&lt;/font&gt;&lt;/b&gt;&lt;font color=&quot;#080808&quot;&gt;，或者不满8192但是sendQueue已经读取完毕&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;color: rgb(8, 8, 8); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;  ptr.doSend(&lt;span style=&quot;color:#000000;&quot;&gt;tmp&lt;/span&gt;); //发送&lt;/pre&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;}&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="2060" y="3060" width="610" height="220" as="geometry" />
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-27" value="" style="endArrow=classic;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="2300" y="2980" as="sourcePoint" />
            <mxPoint x="2300" y="3080" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-28" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;.AppleSystemUIFont&#39;;font-size:9.8pt;&quot;&gt;AgentProtocolClientFilterLayer&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="3120" y="2560" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-29" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;doSend(&lt;span style=&quot;color:#9e880d;&quot;&gt;@NonNull &lt;/span&gt;&lt;span style=&quot;color:#000000;&quot;&gt;ByteBuffer &lt;/span&gt;data)&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="3085" y="2715" width="270" height="40" as="geometry" />
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-30" value="" style="endArrow=classic;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="3210" y="2640" as="sourcePoint" />
            <mxPoint x="3210" y="2690" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-31" value="当sendQueue有数据时（不止这种条件）先保存到sendQueue中&lt;br&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;sendQueue.put(data);&lt;/pre&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;flushSend(sendQueue);&lt;/pre&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="3010" y="2831" width="210" height="94" as="geometry" />
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-32" value="当sendQueuue没数据时直接发送&lt;br&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;next().doSend(data)&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="3280" y="2840" width="180" height="37" as="geometry" />
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-33" value="发送自身数据next().doSend(&lt;font color=&quot;#871094&quot;&gt;self_data&lt;/font&gt;&lt;span style=&quot;background-color: rgb(255, 255, 255); color: rgb(8, 8, 8); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;)&lt;/span&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="3510" y="2833" width="160" height="30" as="geometry" />
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-34" value="" style="endArrow=classic;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="3290" y="2770" as="sourcePoint" />
            <mxPoint x="3590" y="2820" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-35" value="" style="endArrow=classic;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="3270" y="2790" as="sourcePoint" />
            <mxPoint x="3370" y="2820" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-36" value="" style="endArrow=classic;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="3210" y="2765" as="sourcePoint" />
            <mxPoint x="3120" y="2825" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-37" value="&lt;b&gt;&lt;font color=&quot;#ff6666&quot;&gt;data的大小未知&lt;/font&gt;&lt;/b&gt;， 可能会很大，不止8192(上一层的发送就已经未知大小)" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="3350" y="2705" width="220" height="25" as="geometry" />
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-38" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;有ByteBufferQueue &lt;span style=&quot;color:#871094;&quot;&gt;sendQueue&lt;/span&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-690" y="2570" width="230" height="30" as="geometry" />
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-39" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;有ByteBufferQueue &lt;span style=&quot;color:#871094;&quot;&gt;sendQueue&lt;/span&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="2270" y="2520" width="230" height="30" as="geometry" />
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-40" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;有ByteBufferQueue &lt;span style=&quot;color:#871094;&quot;&gt;sendQueue&lt;/span&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="3120" y="2510" width="230" height="30" as="geometry" />
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-41" value="&lt;pre style=&quot;border-color: var(--border-color); color: rgb(8, 8, 8); font-size: 9.8pt; text-align: left; font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace;&quot;&gt;有ConcurrentLinkedQueue保存&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="205" y="2550" width="220" height="30" as="geometry" />
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-42" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;.AppleSystemUIFont&#39;;font-size:9.8pt;&quot;&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;BIONetworkLayer&lt;/pre&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="3870" y="2555" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-43" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;doSend(&lt;span style=&quot;color:#9e880d;&quot;&gt;@NonNull &lt;/span&gt;&lt;span style=&quot;color:#000000;&quot;&gt;ByteBuffer &lt;/span&gt;data)&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="3840" y="2690" width="270" height="40" as="geometry" />
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-44" value="&lt;b&gt;&lt;font color=&quot;#ff6666&quot;&gt;data的大小未知&lt;/font&gt;&lt;/b&gt;， 可能会很大，不止8192(上一层的发送就已经未知大小)" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="4150" y="2697.5" width="220" height="25" as="geometry" />
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-45" value="&lt;pre style=&quot;text-align: left; background-color: rgb(255, 255, 255); color: rgb(8, 8, 8); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;ByteBufferQueue send&lt;span style=&quot;color:#871094;&quot;&gt;Queue（似乎不起作用）&lt;/span&gt;&lt;/pre&gt;&lt;div style=&quot;text-align: left;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;有ByteBufferQueue &lt;/span&gt;&lt;span style=&quot;background-color: initial; font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt; color: rgb(135, 16, 148);&quot;&gt;writeQueue， 起作用的是这个&lt;/span&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="3810" y="2470" width="360" height="80" as="geometry" />
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-46" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;writeQueue.put(data);&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="3860" y="2820" width="200" height="20" as="geometry" />
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-47" value="" style="endArrow=classic;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="3974.5" y="2630" as="sourcePoint" />
            <mxPoint x="3974.5" y="2680" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-48" value="" style="endArrow=classic;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="3969.5" y="2725" as="sourcePoint" />
            <mxPoint x="3969.5" y="2765" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-49" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;getIoHub().execute(writer)&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="3875" y="2773" width="200" height="37" as="geometry" />
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-50" value="关键的部分，开启一个线程处理writeQueue" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="4150" y="2787" width="170" height="23" as="geometry" />
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-51" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;IOHub&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;dashed=1;" parent="1" vertex="1">
          <mxGeometry x="4580" y="2540" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-52" value="&lt;pre style=&quot;text-align: justify; background-color: rgb(255, 255, 255); color: rgb(8, 8, 8); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;write.run()&lt;/pre&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;dashed=1;align=left;" parent="1" vertex="1">
          <mxGeometry x="3890" y="2910" width="110" height="43" as="geometry" />
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-53" value="&lt;b&gt;write线程&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="3790" y="2922" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-54" value="" style="endArrow=classic;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;dashed=1;dashPattern=8 8;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="3950" y="2847" as="sourcePoint" />
            <mxPoint x="3950" y="2900" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-55" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;ByteBuffer data = acquire(); //向IoHub中的bufferPool申请一个limit 8192(capacity实际是16916)的ByteBuffer&lt;/pre&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;while(writeQueue.hasRemaining()){ //循环发送&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;writeQueue.get(&lt;span style=&quot;color:#000000;&quot;&gt;data&lt;/span&gt;)&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;((Buffer&lt;span style=&quot;font-size: 9.8pt;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;font-size: 9.8pt; color: rgb(0, 0, 0);&quot;&gt;data&lt;/span&gt;&lt;span style=&quot;font-size: 9.8pt;&quot;&gt;).flip()&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;&lt;span style=&quot;font-size: 9.8pt;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/span&gt;    while (&lt;span style=&quot;font-size: 9.8pt; color: rgb(0, 0, 0);&quot;&gt;data&lt;/span&gt;&lt;span style=&quot;font-size: 9.8pt;&quot;&gt;.remaining() &amp;gt; &lt;/span&gt;&lt;span style=&quot;font-size: 9.8pt; color: rgb(23, 80, 235);&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;font-size: 9.8pt;&quot;&gt;) {&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;&lt;span style=&quot;font-size: 9.8pt;&quot;&gt;        &lt;/span&gt;out.write(&lt;span style=&quot;font-size: 9.8pt; color: rgb(0, 0, 0);&quot;&gt;data&lt;/span&gt;&lt;span style=&quot;font-size: 9.8pt;&quot;&gt;);              //out是通道，真正向通道发送数据（所以每次发送的数据最大就是8192字节）&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;&lt;span style=&quot;font-size: 9.8pt;&quot;&gt;    }&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;}&lt;/pre&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="3860" y="3110" width="680" height="40" as="geometry" />
        </mxCell>
        <mxCell id="cQ-BIh9Kksjrct9Q46Q1-56" value="" style="endArrow=classic;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="3944.5" y="2963" as="sourcePoint" />
            <mxPoint x="3944.5" y="3003" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="0n1Nj1Sivc76l-1BmOpA-1" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;ChannelApplicationLayer&lt;/pre&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="-1630" y="2605" width="230" height="60" as="geometry" />
        </mxCell>
        <mxCell id="0n1Nj1Sivc76l-1BmOpA-2" value="" style="endArrow=classic;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-1580" y="2700" as="sourcePoint" />
            <mxPoint x="-1580" y="2740" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="0n1Nj1Sivc76l-1BmOpA-3" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;write(&lt;span style=&quot;color:#000000;&quot;&gt;ByteBuffer &lt;/span&gt;header, &lt;span style=&quot;color:#000000;&quot;&gt;ByteBuffer &lt;/span&gt;data)&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-1850" y="2745" width="390" height="55" as="geometry" />
        </mxCell>
        <mxCell id="0n1Nj1Sivc76l-1BmOpA-4" value="" style="endArrow=classic;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-1440" y="2682.5" as="sourcePoint" />
            <mxPoint x="-1260" y="2760" as="targetPoint" />
            <Array as="points">
              <mxPoint x="-1440" y="2730" />
              <mxPoint x="-1260" y="2730" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="0n1Nj1Sivc76l-1BmOpA-5" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;write(self_data)&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-1380" y="2768" width="230" height="32" as="geometry" />
        </mxCell>
        <mxCell id="0n1Nj1Sivc76l-1BmOpA-6" value="" style="endArrow=classic;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-1630" y="2813" as="sourcePoint" />
            <mxPoint x="-1630" y="2893" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="0n1Nj1Sivc76l-1BmOpA-7" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;ptr.doSend(header)&lt;/pre&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;ptr.doSend(data)&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-1740" y="2913.5" width="230" height="47" as="geometry" />
        </mxCell>
        <mxCell id="0n1Nj1Sivc76l-1BmOpA-8" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;ptr.doSend(self_data)&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-1340" y="2900" width="190" height="74" as="geometry" />
        </mxCell>
        <mxCell id="0n1Nj1Sivc76l-1BmOpA-9" value="" style="endArrow=classic;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-1260" y="2818.5" as="sourcePoint" />
            <mxPoint x="-1260" y="2898.5" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="0n1Nj1Sivc76l-1BmOpA-10" value="发送自身数据（84字节）,发送的是Capability对象" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-1340" y="2660" width="150" height="30" as="geometry" />
        </mxCell>
        <mxCell id="0n1Nj1Sivc76l-1BmOpA-11" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;rO0ABXNyABpodWRzb24ucmVtb3RpbmcuQ2FwYWJpbGl0eQAAAAAAAAABAgABSgAEbWFza3hwAAAAAAAAAf4&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-1380" y="2685" width="640" height="25" as="geometry" />
        </mxCell>
        <mxCell id="0n1Nj1Sivc76l-1BmOpA-13" value="发送自身数据self_data： BYE&lt;br&gt;及首部字段（101 byte）:&lt;br&gt;&amp;nbsp;{&quot;Node-Name&quot;:&quot;node1&quot;,&quot;Secret-Key&quot;:&quot;1ace6c05372c72d6a7226258e7f959354fea9afa00bb0a93d631678c5f1a5170&quot;}" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-510" y="2720" width="705" height="29" as="geometry" />
        </mxCell>
        <mxCell id="0n1Nj1Sivc76l-1BmOpA-14" value="self_data:&amp;nbsp; ACK" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="2735" y="2955" width="145" height="25" as="geometry" />
        </mxCell>
        <mxCell id="0n1Nj1Sivc76l-1BmOpA-15" value="self_data(22 byte):&amp;nbsp; &quot;Protocol:JNLP4-connect&quot;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="3510" y="2877" width="260" height="33" as="geometry" />
        </mxCell>
        <mxCell id="0n1Nj1Sivc76l-1BmOpA-18" value="" style="shape=link;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" parent="1" edge="1">
          <mxGeometry width="100" relative="1" as="geometry">
            <mxPoint x="-2060" y="3360" as="sourcePoint" />
            <mxPoint x="4970.34" y="3373" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="0n1Nj1Sivc76l-1BmOpA-19" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;ByteBuffer buffer = acquire();  //向IoHub中的bufferPool申请一个limit 8192(capacity实际是16916)的ByteBuffer&lt;/pre&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;while (&lt;span style=&quot;color:#871094;&quot;&gt;in&lt;/span&gt;.isOpen()）{ //循环读取&lt;/pre&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;in.read(&lt;span style=&quot;font-size: 9.8pt; color: rgb(0, 0, 0);&quot;&gt;buffer&lt;/span&gt;&lt;span style=&quot;font-size: 9.8pt;&quot;&gt;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;span style=&quot;font-size: 9.8pt;&quot;&gt;    &lt;/span&gt;((Buffer&lt;span style=&quot;font-size: 9.8pt;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;font-size: 9.8pt; color: rgb(0, 0, 0);&quot;&gt;buffer&lt;/span&gt;&lt;span style=&quot;font-size: 9.8pt;&quot;&gt;).flip();&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;span style=&quot;font-size: 9.8pt;&quot;&gt;    &lt;/span&gt;while (&lt;span style=&quot;font-size: 9.8pt; color: rgb(0, 0, 0);&quot;&gt;buffer&lt;/span&gt;&lt;span style=&quot;font-size: 9.8pt;&quot;&gt;.hasRemaining()) {&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;        onRead(&lt;span style=&quot;color:#000000;&quot;&gt;buffer&lt;/span&gt;);&lt;br&gt;    &lt;br&gt;    }&lt;/pre&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;}&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="3890" y="3480" width="830" height="70" as="geometry" />
        </mxCell>
        <mxCell id="0n1Nj1Sivc76l-1BmOpA-20" value="&lt;b&gt;read线程&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="3760" y="3430" width="80" height="20" as="geometry" />
        </mxCell>
        <mxCell id="0n1Nj1Sivc76l-1BmOpA-23" value="所有发送数据放入writeQueue中排队，而不是直接发送" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="4135" y="2823" width="230" height="30" as="geometry" />
        </mxCell>
        <mxCell id="0n1Nj1Sivc76l-1BmOpA-24" value="" style="endArrow=classic;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="4190" y="3660" as="sourcePoint" />
            <mxPoint x="4190" y="3730" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="0n1Nj1Sivc76l-1BmOpA-25" value="recvQueue有数据则放入recvQueue中排队" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="4135" y="3730" width="245" height="30" as="geometry" />
        </mxCell>
        <mxCell id="0n1Nj1Sivc76l-1BmOpA-26" value="" style="endArrow=classic;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="3920" y="3650" as="sourcePoint" />
            <mxPoint x="3920" y="3740" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="0n1Nj1Sivc76l-1BmOpA-27" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;flushRecvQueue()&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="4110" y="3790" width="200" height="30" as="geometry" />
        </mxCell>
        <mxCell id="0n1Nj1Sivc76l-1BmOpA-28" value="" style="endArrow=classic;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="4190" y="3820" as="sourcePoint" />
            <mxPoint x="4190" y="3890" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="0n1Nj1Sivc76l-1BmOpA-29" value="recvQueue中没有数据则直接处理&lt;br&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;ptr.onRecv(data)&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="3820" y="3760" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="0n1Nj1Sivc76l-1BmOpA-30" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;ByteBuffer tmp = &lt;span style=&quot;color:#871094;&quot;&gt;recvQueue&lt;/span&gt;.newByteBuffer(); //申请8192的buffer&lt;br&gt;&lt;span style=&quot;color:#0033b3;&quot;&gt;while &lt;/span&gt;(&lt;span style=&quot;color:#871094;&quot;&gt;recvQueue&lt;/span&gt;.hasRemaining()) {&lt;br&gt;    ((&lt;span style=&quot;color:#000000;&quot;&gt;Buffer&lt;/span&gt;) &lt;span style=&quot;color:#000000;&quot;&gt;tmp&lt;/span&gt;).clear();&lt;br&gt;    &lt;span style=&quot;color:#871094;&quot;&gt;recvQueue&lt;/span&gt;.get(&lt;span style=&quot;color:#000000;&quot;&gt;tmp&lt;/span&gt;);&lt;br&gt;    ((&lt;span style=&quot;color:#000000;&quot;&gt;Buffer&lt;/span&gt;) &lt;span style=&quot;color:#000000;&quot;&gt;tmp&lt;/span&gt;).flip();&lt;br&gt;    &lt;span style=&quot;color:#871094;&quot;&gt;ptr&lt;/span&gt;.onRecv(&lt;span style=&quot;color:#000000;&quot;&gt;tmp&lt;/span&gt;);&lt;br&gt;}&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="4110" y="3900" width="520" height="160" as="geometry" />
        </mxCell>
        <mxCell id="0n1Nj1Sivc76l-1BmOpA-31" value="" style="shape=curlyBracket;whiteSpace=wrap;html=1;rounded=1;flipH=1;labelPosition=right;verticalLabelPosition=middle;align=left;verticalAlign=middle;rotation=90;" parent="1" vertex="1">
          <mxGeometry x="4110" y="3850" width="80" height="530" as="geometry" />
        </mxCell>
        <mxCell id="0n1Nj1Sivc76l-1BmOpA-32" value="&lt;b&gt;由上我们知道每次处理不超过8192字节；不管是发送还是接收&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="4040" y="4150" width="240" height="90" as="geometry" />
        </mxCell>
        <mxCell id="0n1Nj1Sivc76l-1BmOpA-33" value="&lt;div style=&quot;text-align: left;&quot;&gt;onRecv(&lt;span style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt; text-align: center;&quot;&gt;ByteBuffer &lt;/span&gt;&lt;span style=&quot;background-color: rgb(255, 255, 255); color: rgb(8, 8, 8); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt; text-align: center;&quot;&gt;data&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;) {&lt;/span&gt;&lt;/div&gt;&lt;pre style=&quot;text-align: left; background-color: rgb(255, 255, 255); color: rgb(8, 8, 8); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;    next().onRecv(data)&lt;/pre&gt;&lt;div style=&quot;text-align: left;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;}&lt;/span&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="3250" y="3410" width="270" height="90" as="geometry" />
        </mxCell>
        <mxCell id="0n1Nj1Sivc76l-1BmOpA-34" value="" style="endArrow=classic;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="3368.67" y="3510" as="sourcePoint" />
            <mxPoint x="3369" y="3620" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="0n1Nj1Sivc76l-1BmOpA-35" value="本层接收不做任何处理，直接让上层处理" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="3250" y="3640" width="260" height="70" as="geometry" />
        </mxCell>
        <mxCell id="0n1Nj1Sivc76l-1BmOpA-36" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;onRecv(&lt;span style=&quot;color:#000000;&quot;&gt;ByteBuffer &lt;/span&gt;data)&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="2265" y="3410" width="265" height="40" as="geometry" />
        </mxCell>
        <mxCell id="0n1Nj1Sivc76l-1BmOpA-37" value="" style="endArrow=classic;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="2280" y="3490" as="sourcePoint" />
            <mxPoint x="2280" y="3580" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="0n1Nj1Sivc76l-1BmOpA-38" value="recvQueue中没有数据则直接处理&lt;br&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;ptr.onRecv(data)&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="2180" y="3600" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="0n1Nj1Sivc76l-1BmOpA-39" value="" style="endArrow=classic;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="2545" y="3490" as="sourcePoint" />
            <mxPoint x="2545" y="3560" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="0n1Nj1Sivc76l-1BmOpA-40" value="recvQueue有数据则放入recvQueue中排队&lt;br&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;recvQueue.put(data)&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="2465" y="3580" width="245" height="30" as="geometry" />
        </mxCell>
        <mxCell id="0n1Nj1Sivc76l-1BmOpA-41" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;flushRecv()&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="2465" y="3620" width="200" height="30" as="geometry" />
        </mxCell>
        <mxCell id="0n1Nj1Sivc76l-1BmOpA-42" value="" style="endArrow=classic;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="2545" y="3650" as="sourcePoint" />
            <mxPoint x="2545" y="3720" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="0n1Nj1Sivc76l-1BmOpA-43" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;ByteBuffer tmp = &lt;span style=&quot;color:#871094;&quot;&gt;recvQueue&lt;/span&gt;.newByteBuffer(); //申请8192的buffer&lt;br&gt;&lt;span style=&quot;color:#0033b3;&quot;&gt;while &lt;/span&gt;(&lt;span style=&quot;color:#871094;&quot;&gt;recvQueue&lt;/span&gt;.hasRemaining()) {&lt;br&gt;    ((&lt;span style=&quot;color:#000000;&quot;&gt;Buffer&lt;/span&gt;) &lt;span style=&quot;color:#000000;&quot;&gt;tmp&lt;/span&gt;).clear();&lt;br&gt;    &lt;span style=&quot;color:#871094;&quot;&gt;recvQueue&lt;/span&gt;.get(&lt;span style=&quot;color:#000000;&quot;&gt;tmp&lt;/span&gt;);&lt;br&gt;    ((&lt;span style=&quot;color:#000000;&quot;&gt;Buffer&lt;/span&gt;) &lt;span style=&quot;color:#000000;&quot;&gt;tmp&lt;/span&gt;).flip();&lt;br&gt;    &lt;span style=&quot;color:#871094;&quot;&gt;ptr&lt;/span&gt;.onRecv(&lt;span style=&quot;color:#000000;&quot;&gt;tmp&lt;/span&gt;);&lt;br&gt;}&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="2465" y="3725" width="520" height="160" as="geometry" />
        </mxCell>
        <mxCell id="0n1Nj1Sivc76l-1BmOpA-44" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;onRecv(&lt;span style=&quot;color:#000000;&quot;&gt;ByteBuffer &lt;/span&gt;readBuffer)&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="235" y="3410" width="245" height="40" as="geometry" />
        </mxCell>
        <mxCell id="0n1Nj1Sivc76l-1BmOpA-45" value="" style="endArrow=classic;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="349.33" y="3470" as="sourcePoint" />
            <mxPoint x="349.33" y="3530" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="0n1Nj1Sivc76l-1BmOpA-46" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;br&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;if (&lt;span style=&quot;color:#871094;&quot;&gt;previous &lt;/span&gt;!= &lt;span style=&quot;color:#0033b3;&quot;&gt;null&lt;/span&gt;) {&lt;br&gt;    &lt;span style=&quot;color:#000000;&quot;&gt;tempBuffer &lt;/span&gt;= &lt;span style=&quot;color:#871094;&quot;&gt;previous &lt;/span&gt;= &lt;span style=&quot;color:#000000;&quot;&gt;ByteBufferUtils&lt;/span&gt;.&lt;span style=&quot;font-style:italic;&quot;&gt;accumulate&lt;/span&gt;(readBuffer, &lt;span style=&quot;color:#871094;&quot;&gt;previous&lt;/span&gt;);&lt;br&gt;} &lt;span style=&quot;color:#0033b3;&quot;&gt;else &lt;/span&gt;{&lt;br&gt;    &lt;span style=&quot;color:#000000;&quot;&gt;tempBuffer &lt;/span&gt;= readBuffer;&lt;br&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;span style=&quot;font-size: 9.8pt;&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;pre style=&quot;border-color: var(--border-color); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;//向IoHub中的bufferPool申请一个limit 16704(capacity实际是16916)的ByteBuffer&lt;/pre&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;ByteBuffer appBuffer = stack().acquire(sslEngine.getSession().getApplicationBufferSize()); &lt;/pre&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;result = &lt;span style=&quot;color:#871094;&quot;&gt;sslEngine&lt;/span&gt;.unwrap(&lt;span style=&quot;color:#000000;&quot;&gt;tempBuffer&lt;/span&gt;, &lt;span style=&quot;color:#000000;&quot;&gt;appBuffer&lt;/span&gt;);&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;((Buffer) &lt;span style=&quot;color:#000000;&quot;&gt;appBuffer&lt;/span&gt;).flip();&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;next().onRecv(appBuffer);&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;&lt;br&gt;&lt;/pre&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="114" y="3630" width="1579" height="70" as="geometry" />
        </mxCell>
        <mxCell id="Hq2ewR72OK_mTviOB1mo-1" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;JnlpProtocol4Handler.connect(....)&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="425" y="610" width="436" height="30" as="geometry" />
        </mxCell>
        <mxCell id="Hq2ewR72OK_mTviOB1mo-2" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="375" y="650" as="sourcePoint" />
            <mxPoint x="1035" y="650" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="Hq2ewR72OK_mTviOB1mo-3" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;6.connect&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="277" y="590" width="90" height="25" as="geometry" />
        </mxCell>
        <mxCell id="7xBDg8h49Le0EDPpn1vZ-2" value="" style="shape=curlyBracket;whiteSpace=wrap;html=1;rounded=1;flipH=1;labelPosition=right;verticalLabelPosition=middle;align=left;verticalAlign=middle;rotation=90;" parent="1" vertex="1">
          <mxGeometry x="2420" y="3710" width="80" height="530" as="geometry" />
        </mxCell>
        <mxCell id="7xBDg8h49Le0EDPpn1vZ-3" value="最大8192字节" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="2340" y="4040" width="210" height="30" as="geometry" />
        </mxCell>
        <mxCell id="7xBDg8h49Le0EDPpn1vZ-4" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;b&gt;AckFilterLayer的作用：&lt;/b&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;b&gt;发送“ACK”字符串&lt;/b&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;b&gt;接收“ACK”字符串&lt;/b&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;b&gt;只有这两样处理完成，才能进一步send其他数据, 不然就放在sendQueue里&lt;/b&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="2185" y="4092" width="520" height="160" as="geometry" />
        </mxCell>
        <mxCell id="5ELjpxrQgCRXJpdXmUJf-1" value="" style="shape=link;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" parent="1" edge="1">
          <mxGeometry width="100" relative="1" as="geometry">
            <mxPoint x="-2050" y="4110" as="sourcePoint" />
            <mxPoint x="4980.34" y="4123" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="5ELjpxrQgCRXJpdXmUJf-2" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;listener = JnlpProtocol4Handler#Handler&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="294" y="3880" width="336" height="30" as="geometry" />
        </mxCell>
        <mxCell id="5ELjpxrQgCRXJpdXmUJf-4" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="424" y="3920" as="sourcePoint" />
            <mxPoint x="424" y="3970" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="5ELjpxrQgCRXJpdXmUJf-5" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;listener.onHandshakeCompleted(&lt;span style=&quot;color:#871094;&quot;&gt;sslEngine&lt;/span&gt;.getSession())&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="290" y="3980" width="431" height="20" as="geometry" />
        </mxCell>
        <mxCell id="5ELjpxrQgCRXJpdXmUJf-6" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="424" y="4020" as="sourcePoint" />
            <mxPoint x="424" y="4070" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="5ELjpxrQgCRXJpdXmUJf-7" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;jnlp4ConnectionState.fireBeforeProperties（X509Certificate）&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="288" y="4084" width="403" height="26" as="geometry" />
        </mxCell>
        <mxCell id="5ELjpxrQgCRXJpdXmUJf-8" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="425" y="4120" as="sourcePoint" />
            <mxPoint x="425" y="4170" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="5ELjpxrQgCRXJpdXmUJf-10" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;this.&lt;span style=&quot;color:#871094;&quot;&gt;certificate &lt;/span&gt;= certificate; //保存证书到jnlp4ConnectionState&lt;/pre&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;lifecycle = &lt;span style=&quot;color:#000000;&quot;&gt;State&lt;/span&gt;.&lt;span style=&quot;color:#871094;font-style:italic;&quot;&gt;BEFORE_PROPERTIES&lt;/span&gt;;//设置生命周期到jnlp4ConnectionState&lt;/pre&gt;&lt;/pre&gt;listener=Engine#EngineJnlpConnectionStateListener&lt;br&gt;listerner.beforeProperties(jnlp4ConnectionState&lt;span style=&quot;background-color: initial;&quot;&gt;)&lt;/span&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="239.25" y="4170" width="590.75" height="70" as="geometry" />
        </mxCell>
        <mxCell id="5ELjpxrQgCRXJpdXmUJf-11" value="listerner.beforeProperties(jnlp4ConnectionState)主要是验证证书的有效性（从证书拿出公钥比较）" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="340" y="4280" width="299" height="30" as="geometry" />
        </mxCell>
        <mxCell id="086Q5PK0GUfrbWCXx4qv-9" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;listener = JnlpProtocol4Handler#Handler&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-714" y="3940" width="336" height="30" as="geometry" />
        </mxCell>
        <mxCell id="086Q5PK0GUfrbWCXx4qv-10" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-584" y="3980" as="sourcePoint" />
            <mxPoint x="-584" y="4030" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="086Q5PK0GUfrbWCXx4qv-11" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;listener.onReceiveHeaders(&lt;span style=&quot;color:#000000;&quot;&gt;headers&lt;/span&gt;)&lt;/pre&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-718" y="4040" width="431" height="20" as="geometry" />
        </mxCell>
        <mxCell id="086Q5PK0GUfrbWCXx4qv-12" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-584" y="4080" as="sourcePoint" />
            <mxPoint x="-584" y="4130" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="086Q5PK0GUfrbWCXx4qv-13" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;jnlp4ConnectionState.fireAfterProperties(headers)&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-720" y="4144" width="403" height="26" as="geometry" />
        </mxCell>
        <mxCell id="086Q5PK0GUfrbWCXx4qv-14" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-583" y="4180" as="sourcePoint" />
            <mxPoint x="-583" y="4230" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="086Q5PK0GUfrbWCXx4qv-15" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;this&lt;span style=&quot;font-size: 9.8pt;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;font-size: 9.8pt; color: rgb(135, 16, 148);&quot;&gt;properties &lt;/span&gt;&lt;span style=&quot;font-size: 9.8pt;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-size: 9.8pt; color: rgb(0, 51, 179);&quot;&gt;new &lt;/span&gt;&lt;span style=&quot;font-size: 9.8pt;&quot;&gt;HashMap&amp;lt;&amp;gt;(headers)&lt;/span&gt;;&lt;/pre&gt;listener=Engine#EngineJnlpConnectionStateListener&lt;br&gt;listerner.afterProperties&lt;span style=&quot;background-color: initial;&quot;&gt;(jnlp4ConnectionState&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;)&lt;/span&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-703.75" y="4230" width="381.5" height="70" as="geometry" />
        </mxCell>
        <mxCell id="086Q5PK0GUfrbWCXx4qv-16" value="listerner.afterProperties(jnlp4ConnectionState)主要是&lt;br&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;span style=&quot;color:#871094;&quot;&gt;设置生命周期状态：lifecycle &lt;/span&gt;= &lt;span style=&quot;color:#000000;&quot;&gt;State&lt;/span&gt;.&lt;span style=&quot;color:#871094;font-style:italic;&quot;&gt;APPROVED&lt;/span&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-667" y="4320" width="299" height="30" as="geometry" />
        </mxCell>
        <mxCell id="086Q5PK0GUfrbWCXx4qv-17" value="headers是{&quot;JnlpAgentProtocol.cookie&quot;:&quot;04328d1c5ae687437736d044364e0c100562d7c10ac849ca9f136e0bf6c06a99&quot;}" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-441" y="3990" width="555" height="40" as="geometry" />
        </mxCell>
        <mxCell id="086Q5PK0GUfrbWCXx4qv-18" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;onRecvClosed&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-1796.75" y="4450" width="130" height="30" as="geometry" />
        </mxCell>
        <mxCell id="086Q5PK0GUfrbWCXx4qv-19" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-1436.75" y="4465" as="sourcePoint" />
            <mxPoint x="-1606.75" y="4464.5" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="086Q5PK0GUfrbWCXx4qv-20" value="如果master关闭（比如jenkins关闭）" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-1566.75" y="4390" width="130" height="30" as="geometry" />
        </mxCell>
        <mxCell id="086Q5PK0GUfrbWCXx4qv-21" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-1732.25" y="4480" as="sourcePoint" />
            <mxPoint x="-1732.25" y="4530" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="086Q5PK0GUfrbWCXx4qv-22" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;channel.terminate(cause）&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-1786.75" y="4550" width="190" height="20" as="geometry" />
        </mxCell>
        <mxCell id="086Q5PK0GUfrbWCXx4qv-23" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;listener=JnlpProtocol4Handler#Handler&lt;/pre&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;listener.onClosed(&lt;span style=&quot;font-size: 9.8pt;&quot;&gt;channel,&lt;/span&gt;&lt;span style=&quot;font-size: 9.8pt; color: rgb(0, 0, 0);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;font-size: 9.8pt;&quot;&gt;cause)&lt;/span&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-1886.75" y="4660" width="440" height="30" as="geometry" />
        </mxCell>
        <mxCell id="086Q5PK0GUfrbWCXx4qv-24" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-1722.25" y="4580" as="sourcePoint" />
            <mxPoint x="-1722.25" y="4630" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="086Q5PK0GUfrbWCXx4qv-25" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;jnlp4ConnectionState.fireChannelClosed(cause)&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-1859.75" y="4750" width="403" height="26" as="geometry" />
        </mxCell>
        <mxCell id="086Q5PK0GUfrbWCXx4qv-26" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-1722.75" y="4786" as="sourcePoint" />
            <mxPoint x="-1722.75" y="4836" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="086Q5PK0GUfrbWCXx4qv-27" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;closeCause = cause;    设置close原因&lt;br&gt;&lt;span style=&quot;color:#871094;&quot;&gt;lifecycle &lt;/span&gt;= &lt;span style=&quot;color:#000000;&quot;&gt;State&lt;/span&gt;.&lt;span style=&quot;color:#871094;font-style:italic;&quot;&gt;CHANNEL_CLOSED&lt;/span&gt;;  设置生命周期&lt;/pre&gt;&lt;/pre&gt;listener=Engine#EngineJnlpConnectionStateListener&lt;br&gt;listerner.channelClosed&lt;span style=&quot;background-color: initial;&quot;&gt;(jnlp4ConnectionState&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;)&lt;/span&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-1936.75" y="4840" width="466.75" height="70" as="geometry" />
        </mxCell>
        <mxCell id="086Q5PK0GUfrbWCXx4qv-28" value="listerner.channelClosed&lt;span style=&quot;background-color: initial;&quot;&gt;(jnlp4ConnectionState)是空函数&lt;br&gt;&lt;/span&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-1845.75" y="4940" width="299" height="30" as="geometry" />
        </mxCell>
        <mxCell id="086Q5PK0GUfrbWCXx4qv-29" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-1716.75" y="4700" as="sourcePoint" />
            <mxPoint x="-1716.75" y="4750" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="086Q5PK0GUfrbWCXx4qv-30" value="" style="endArrow=classic;html=1;rounded=0;exitX=0.642;exitY=1.183;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-1705.02" y="4482.75" as="sourcePoint" />
            <mxPoint x="-1366.75" y="4530" as="targetPoint" />
            <Array as="points">
              <mxPoint x="-1366.75" y="4483" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="086Q5PK0GUfrbWCXx4qv-31" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;.AppleSystemUIFont&#39;;font-size:9.8pt;&quot;&gt;ProtocolStack.onClosed(&lt;span style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;cause)&lt;/span&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-1446.75" y="4550" width="200" height="20" as="geometry" />
        </mxCell>
        <mxCell id="086Q5PK0GUfrbWCXx4qv-32" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;listener=JnlpProtocol4Handler#Handler&lt;/pre&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;listener.onClosed(ProtocolStack, &lt;span style=&quot;font-size: 9.8pt;&quot;&gt;cause)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-1516.75" y="4660" width="440" height="30" as="geometry" />
        </mxCell>
        <mxCell id="086Q5PK0GUfrbWCXx4qv-34" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-1356.75" y="4580" as="sourcePoint" />
            <mxPoint x="-1356.75" y="4630" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="086Q5PK0GUfrbWCXx4qv-35" value="先关闭channle" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-1856.75" y="4500" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="086Q5PK0GUfrbWCXx4qv-36" value="再关闭stack" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-1346.75" y="4490" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="086Q5PK0GUfrbWCXx4qv-37" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;jnlp4ConnectionState.fireAfterDisconnect()&lt;br&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-1436.75" y="4765" width="403" height="26" as="geometry" />
        </mxCell>
        <mxCell id="086Q5PK0GUfrbWCXx4qv-38" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-1299.75" y="4801" as="sourcePoint" />
            <mxPoint x="-1299.75" y="4851" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="086Q5PK0GUfrbWCXx4qv-40" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-1336.75" y="4700" as="sourcePoint" />
            <mxPoint x="-1336.75" y="4750" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="086Q5PK0GUfrbWCXx4qv-41" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;&lt;br&gt;lifecycle &lt;span style=&quot;font-size: 9.8pt;&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;font-size: 9.8pt; color: rgb(0, 0, 0);&quot;&gt;State&lt;/span&gt;&lt;span style=&quot;font-size: 9.8pt;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;font-size: 9.8pt; color: rgb(135, 16, 148); font-style: italic;&quot;&gt;DISCONNECTED&lt;/span&gt;;  设置生命周期&lt;/pre&gt;&lt;/pre&gt;listener=Engine#EngineJnlpConnectionStateListener&lt;br&gt;listerner.afterDisconnect&lt;span style=&quot;background-color: initial;&quot;&gt;(jnlp4ConnectionState&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;)&lt;/span&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-1486.75" y="4860" width="466.75" height="70" as="geometry" />
        </mxCell>
        <mxCell id="086Q5PK0GUfrbWCXx4qv-42" value="listerner.afterDisconnect&lt;span style=&quot;background-color: initial;&quot;&gt;(jnlp4ConnectionState)是空函数&lt;/span&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-1392.75" y="4950" width="299" height="30" as="geometry" />
        </mxCell>
        <mxCell id="SSMVNDvQ-9tZ9NZeTmvC-2" value="" style="endArrow=none;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="4990" y="5300" as="sourcePoint" />
            <mxPoint x="4980" y="-70" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="SSMVNDvQ-9tZ9NZeTmvC-3" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;独立的线程监听：TcpSlaveAgentListener&lt;/pre&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="5290" y="465" width="370" height="150" as="geometry" />
        </mxCell>
        <mxCell id="SSMVNDvQ-9tZ9NZeTmvC-4" value="&lt;font style=&quot;font-size: 25px;&quot;&gt;master side&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="5300" y="70" width="240" height="130" as="geometry" />
        </mxCell>
        <mxCell id="SSMVNDvQ-9tZ9NZeTmvC-6" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="5450" y="620" as="sourcePoint" />
            <mxPoint x="5450" y="680" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="SSMVNDvQ-9tZ9NZeTmvC-7" value="当来socket连接时，启动新线程来处理连接请求" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="5490" y="790" width="150" height="30" as="geometry" />
        </mxCell>
        <mxCell id="SSMVNDvQ-9tZ9NZeTmvC-8" value="accept" style="ellipse;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="5400" y="680" width="120" height="80" as="geometry" />
        </mxCell>
        <mxCell id="SSMVNDvQ-9tZ9NZeTmvC-9" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;new TcpSlaveAgentListener#ConnectionHandler(socket&lt;span style=&quot;font-size: 9.8pt;&quot;&gt;).start();&lt;/span&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="5360" y="820" width="250" height="40" as="geometry" />
        </mxCell>
        <mxCell id="SSMVNDvQ-9tZ9NZeTmvC-10" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="5459.58" y="765.5" as="sourcePoint" />
            <mxPoint x="5459.58" y="825.5" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="SSMVNDvQ-9tZ9NZeTmvC-11" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="5459.58" y="870" as="sourcePoint" />
            <mxPoint x="5459.58" y="920" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="SSMVNDvQ-9tZ9NZeTmvC-12" value="调用：JnlpSlaveAgentProtocol4.handle(socket)" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="5360" y="930" width="260" height="30" as="geometry" />
        </mxCell>
        <mxCell id="SSMVNDvQ-9tZ9NZeTmvC-13" value="JnlpSlaveAgentProtocol4是单例" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="5430" y="900" width="270" height="30" as="geometry" />
        </mxCell>
        <mxCell id="SSMVNDvQ-9tZ9NZeTmvC-14" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="5459.58" y="960" as="sourcePoint" />
            <mxPoint x="5460" y="1010" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="SSMVNDvQ-9tZ9NZeTmvC-15" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;sslContext = &lt;span style=&quot;color:#000000;&quot;&gt;SSLContext&lt;/span&gt;.&lt;span style=&quot;font-style:italic;&quot;&gt;getInstance&lt;/span&gt;(&lt;span style=&quot;color:#067d17;&quot;&gt;&quot;TLS&quot;&lt;/span&gt;);&lt;/pre&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;sslContext.init(&lt;span style=&quot;color:#000000;&quot;&gt;kmf&lt;/span&gt;.getKeyManagers(), &lt;span style=&quot;color:#000000;&quot;&gt;trustManagers&lt;/span&gt;, &lt;span style=&quot;color:#0033b3;&quot;&gt;null&lt;/span&gt;);&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;this.handler = &lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;&lt;span style=&quot;color:#0033b3;&quot;&gt;new &lt;/span&gt;JnlpProtocol4Handler(&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;&lt;span style=&quot;color:#000000;&quot;&gt;JnlpAgentReceiver&lt;/span&gt;.&lt;span style=&quot;color:#871094;font-style:italic;&quot;&gt;DATABASE&lt;/span&gt;, &lt;span style=&quot;color:#000000;&quot;&gt;Computer&lt;/span&gt;.&lt;span style=&quot;color:#871094;font-style:italic;&quot;&gt;threadPoolForRemoting&lt;/span&gt;, &lt;span style=&quot;color:#000000;&quot;&gt;hub&lt;/span&gt;.getHub(),&lt;br&gt;        &lt;span style=&quot;color:#000000;&quot;&gt;sslContext&lt;/span&gt;, &lt;span style=&quot;color:#0033b3;&quot;&gt;false&lt;/span&gt;, &lt;span style=&quot;color:#0033b3;&quot;&gt;true&lt;/span&gt;);&lt;/pre&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="5281.5" y="1020" width="398.5" height="140" as="geometry" />
        </mxCell>
        <mxCell id="SSMVNDvQ-9tZ9NZeTmvC-16" value="生成sslContext并初始化sslContext;&lt;br&gt;生成JnlpProtocol4Handler， 注意，下列代码只有来第一个连接时才执行一次，意味着JnlpProtocol4Handler也只有一例" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="5710" y="1010" width="400" height="30" as="geometry" />
        </mxCell>
        <mxCell id="UaWB042FTOmvel8zbl6t-1" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;pre style=&quot;font-family: &amp;quot;.AppleSystemUIFont&amp;quot;; font-size: 9.8pt;&quot;&gt;NIONetworkLayer&lt;/pre&gt;&lt;/pre&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="931" y="1400" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UaWB042FTOmvel8zbl6t-2" value="&lt;pre style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;ByteBufferQueue包含new ByteBuffer[&lt;font style=&quot;font-size: 9.8pt;&quot; color=&quot;#871094&quot;&gt;&lt;i&gt;16&lt;/i&gt;&lt;/font&gt;&lt;font style=&quot;font-size: 9.8pt;&quot; color=&quot;#080808&quot;&gt;]， 每个8192字节，&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;创建一个recvqueue ByteBufferQueue用来写入接收的数据；&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;创建一个sendqueue：ByteBufferQueue也是用于发送数据；&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="1130" y="1350" width="698" height="90" as="geometry" />
        </mxCell>
        <mxCell id="UaWB042FTOmvel8zbl6t-3" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:11.2pt;&quot;&gt;socketChannel.configureBlocking(&lt;span style=&quot;color:#0033b3;&quot;&gt;false&lt;/span&gt;);&lt;br&gt;getIoHub().register(socketChannel, NIONetworkLayer, false&lt;span style=&quot;font-size: 11.2pt;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;font-size: 11.2pt; color: rgb(0, 51, 179);&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;font-size: 11.2pt;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;font-size: 11.2pt; color: rgb(0, 51, 179);&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;font-size: 11.2pt;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;font-size: 11.2pt; color: rgb(0, 0, 0);&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;font-size: 11.2pt;&quot;&gt;,&lt;/span&gt;&lt;br&gt;        &lt;span style=&quot;color:#0033b3;&quot;&gt;new &lt;/span&gt;RegistrationCallbackImpl(&lt;span style=&quot;color:#0033b3;&quot;&gt;true&lt;/span&gt;, &lt;span style=&quot;color:#0033b3;&quot;&gt;true&lt;/span&gt;, &lt;span style=&quot;color:#000000;&quot;&gt;false&lt;/span&gt;)&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="1114" y="1530" width="560" height="92.5" as="geometry" />
        </mxCell>
        <mxCell id="UaWB042FTOmvel8zbl6t-4" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1310" y="1450" as="sourcePoint" />
            <mxPoint x="1310" y="1520" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UaWB042FTOmvel8zbl6t-7" value="Thread0线程" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="1180" y="1470" width="80" height="30" as="geometry" />
        </mxCell>
        <mxCell id="UaWB042FTOmvel8zbl6t-8" value="注意这时还是Thread0线程，在这个线程里并不真正进行把socketChannel注册到selector中，只是添加到注册队列registrations；真正的注册在IOHub的poolthread0线程中，它会读取注册队列&lt;span style=&quot;color: rgb(135, 16, 148); background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt; text-align: left;&quot;&gt;registrations&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;进行注册&lt;/span&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="1320" y="1450" width="350" height="80" as="geometry" />
        </mxCell>
        <mxCell id="UaWB042FTOmvel8zbl6t-9" value="&lt;font color=&quot;#6666ff&quot;&gt;IOHub pool-thread0线程,while(IOHub.isOpen())轮询调用processRegistrations()&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="1148" y="1720" width="172" height="70" as="geometry" />
        </mxCell>
        <mxCell id="UaWB042FTOmvel8zbl6t-10" value="" style="endArrow=classic;html=1;rounded=0;strokeColor=#6666FF;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1320" y="1720" as="sourcePoint" />
            <mxPoint x="1320" y="1790" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UaWB042FTOmvel8zbl6t-11" value="&lt;pre style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;&lt;font color=&quot;#6666ff&quot;&gt;for (Registration r = registrations.poll(); r != null; r = registrations.poll()) {&lt;br&gt;    try {&lt;br&gt;        SelectionKey selectionKey = r.channel.register(selector, r.ops, r.listener);&lt;br&gt;        processedSomething = true;&lt;br&gt;        r.callback.onRegistered(selectionKey);&lt;br&gt;    } catch (ClosedChannelException e) {&lt;br&gt;        r.callback.onClosedChannel(e);&lt;br&gt;    }&lt;br&gt;}&lt;/font&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="1046" y="1900" width="180" height="76" as="geometry" />
        </mxCell>
        <mxCell id="UaWB042FTOmvel8zbl6t-12" value="Thread0" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="848" y="1415" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="UaWB042FTOmvel8zbl6t-13" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1330" y="1610" as="sourcePoint" />
            <mxPoint x="1330" y="1660" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UaWB042FTOmvel8zbl6t-14" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;registrations.add(&lt;span style=&quot;color:#0033b3;&quot;&gt;new &lt;/span&gt;Registration(&lt;span style=&quot;color:#000000;&quot;&gt;ops&lt;/span&gt;, socketChannel, NIONetworkLayer, callback));//callback 是 RegistrationCallbackImpl&lt;br&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="1400" y="1670" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="UaWB042FTOmvel8zbl6t-15" value="Thread0线程" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="1180" y="1622.5" width="80" height="30" as="geometry" />
        </mxCell>
        <mxCell id="UaWB042FTOmvel8zbl6t-16" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1310" y="1990" as="sourcePoint" />
            <mxPoint x="1310" y="2060" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UaWB042FTOmvel8zbl6t-17" value="&lt;font color=&quot;#6666ff&quot;&gt;当有读写事件时（只注册了读写事件），即selectionKey.readyOps()&lt;span style=&quot;background-color: initial;&quot;&gt;调用&lt;/span&gt;&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="1034" y="2070" width="400" height="30" as="geometry" />
        </mxCell>
        <mxCell id="UaWB042FTOmvel8zbl6t-18" value="&lt;pre style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;&lt;font color=&quot;#6666ff&quot;&gt;executor.execute(new OnReady(&lt;span style=&quot;font-size: 9.8pt;&quot;&gt;_id&lt;/span&gt;&lt;span style=&quot;font-size: 9.8pt;&quot;&gt;, &lt;/span&gt;SelectionKey, NIONetworkLayer, ops&lt;span style=&quot;font-size: 9.8pt;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;font-size: 9.8pt;&quot;&gt;)&lt;/span&gt;&lt;/font&gt;&lt;font color=&quot;#080808&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="1180" y="2100" width="240" height="30" as="geometry" />
        </mxCell>
        <mxCell id="UaWB042FTOmvel8zbl6t-19" value="&lt;pre style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;&lt;font color=&quot;#6666ff&quot;&gt;processRegistrations()&lt;/font&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="1223" y="1790" width="177" height="30" as="geometry" />
        </mxCell>
        <mxCell id="UaWB042FTOmvel8zbl6t-20" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1320" y="1820" as="sourcePoint" />
            <mxPoint x="1320" y="1870" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UaWB042FTOmvel8zbl6t-22" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="2160" y="1730" as="sourcePoint" />
            <mxPoint x="2160" y="1800" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UaWB042FTOmvel8zbl6t-23" value="&lt;pre style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;&lt;font color=&quot;#6666ff&quot;&gt;processInterestOps()&lt;/font&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="2090" y="1810" width="165" height="30" as="geometry" />
        </mxCell>
        <mxCell id="UaWB042FTOmvel8zbl6t-25" value="&lt;font color=&quot;#6666ff&quot;&gt;IOHub pool-thread0线程,while(IOHub.isOpen())轮询调用processInterestOps()&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="1940" y="1730" width="172" height="70" as="geometry" />
        </mxCell>
        <mxCell id="UaWB042FTOmvel8zbl6t-26" value="&lt;font color=&quot;#6666ff&quot;&gt;修改interestOps&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="2090" y="1850" width="140" height="30" as="geometry" />
        </mxCell>
        <mxCell id="UaWB042FTOmvel8zbl6t-27" value="&lt;font color=&quot;#6666ff&quot;&gt;并且删除readyOps()，&lt;font face=&quot;JetBrains Mono, monospace&quot;&gt;&lt;span style=&quot;font-size: 13.0667px; background-color: rgb(255, 255, 255);&quot;&gt;即&lt;/span&gt;&lt;/font&gt;key&lt;span style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;.interestOps(&lt;/span&gt;&lt;span style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;key&lt;/span&gt;&lt;span style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;.interestOps() &amp;amp; ~&lt;/span&gt;&lt;span style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;ops&lt;/span&gt;&lt;span style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;);&lt;/span&gt;&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="1034" y="2130" width="450" height="55" as="geometry" />
        </mxCell>
        <mxCell id="UaWB042FTOmvel8zbl6t-28" value="" style="endArrow=classic;html=1;rounded=0;strokeColor=#0000FF;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1250" y="2210" as="sourcePoint" />
            <mxPoint x="1250" y="2280" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UaWB042FTOmvel8zbl6t-29" value="&lt;pre style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 11.2pt;&quot;&gt;&lt;font color=&quot;#0000ff&quot;&gt;NIONetworkLayer.ready()处理读事件&lt;/font&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="1250" y="2280" width="220" height="40" as="geometry" />
        </mxCell>
        <mxCell id="UaWB042FTOmvel8zbl6t-31" value="&lt;font color=&quot;#0000ff&quot;&gt;线程池中的线程&lt;br&gt;IOHub pool-thread2&lt;br&gt;&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="1147" y="2230" width="94" height="30" as="geometry" />
        </mxCell>
        <mxCell id="UaWB042FTOmvel8zbl6t-32" value="" style="endArrow=classic;html=1;rounded=0;strokeColor=#0000FF;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1250" y="2330" as="sourcePoint" />
            <mxPoint x="1250" y="2400" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UaWB042FTOmvel8zbl6t-33" value="&lt;pre style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 11.2pt;&quot;&gt;&lt;font color=&quot;#0000ff&quot;&gt;一次最大8192字节，循环读取完socketChannel,&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 11.2pt;&quot;&gt;&lt;font color=&quot;#0000ff&quot;&gt;处理完读事件，按照前述已经删除感兴趣的读Ops，此时再加上&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 11.2pt;&quot;&gt;&lt;font color=&quot;#0000ff&quot;&gt;感兴趣兴趣的读：getIoHub().addInterestRead(recvKey&lt;span style=&quot;font-size: 11.2pt;&quot;&gt;);&lt;/span&gt;&lt;/font&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="1001" y="2380" width="480" height="160" as="geometry" />
        </mxCell>
        <mxCell id="UaWB042FTOmvel8zbl6t-34" value="" style="endArrow=classic;html=1;rounded=0;strokeColor=#0000FF;" parent="1" source="UaWB042FTOmvel8zbl6t-29" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1484" y="2330" as="sourcePoint" />
            <mxPoint x="1700" y="2415" as="targetPoint" />
            <Array as="points">
              <mxPoint x="1390" y="2350" />
              <mxPoint x="1700" y="2350" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="UaWB042FTOmvel8zbl6t-36" value="&lt;pre style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 11.2pt;&quot;&gt;&lt;font color=&quot;#0000ff&quot;&gt;一次最大8192字节，往socketChannel写,此处没有循环，&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 11.2pt;&quot;&gt;&lt;font color=&quot;#0000ff&quot;&gt;需要的循环是通过IOHub pool-thread0线程控制的，&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 11.2pt;&quot;&gt;&lt;font color=&quot;#0000ff&quot;&gt;发后如果sendQueue还有数据，再添加感兴的写：&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 11.2pt;&quot;&gt;&lt;font color=&quot;#0000ff&quot;&gt;getIoHub().addInterestWrite(sendKey&lt;span style=&quot;font-size: 11.2pt;&quot;&gt;)&lt;/span&gt;&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 11.2pt;&quot;&gt;&lt;font color=&quot;#0000ff&quot;&gt;（注意，如果NIONetworkLayer.write(ByteBuffer)）往sendQueue添加数据的时候，&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 11.2pt;&quot;&gt;&lt;font color=&quot;#0000ff&quot;&gt;也会在sendQueue事先没有数据时添加感兴趣的写&lt;/font&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="1588" y="2440" width="480" height="160" as="geometry" />
        </mxCell>
        <mxCell id="RVXtcUScIwYpqA5LYpC9-1" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;channel = &lt;span style=&quot;color:#000000;&quot;&gt;protocol&lt;/span&gt;.connect(&lt;span style=&quot;color:#000000;&quot;&gt;jnlpSocket&lt;/span&gt;, &lt;span style=&quot;color:#000000;&quot;&gt;headers&lt;/span&gt;, &lt;span style=&quot;color:#0033b3;&quot;&gt;new &lt;/span&gt;EngineJnlpConnectionStateListener(&lt;span style=&quot;color:#000000;&quot;&gt;endpoint&lt;/span&gt;.getPublicKey(), &lt;span style=&quot;color:#000000;&quot;&gt;headers&lt;/span&gt;)).get();&lt;br&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-1866.5" y="547.5" width="950" height="92.5" as="geometry" />
        </mxCell>
        <mxCell id="RVXtcUScIwYpqA5LYpC9-2" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-870" y="600" as="sourcePoint" />
            <mxPoint x="260" y="600" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="RVXtcUScIwYpqA5LYpC9-3" value="&lt;b&gt;connect函数返回SettableFuture&lt;span style=&quot;background-color: rgb(255, 255, 255); color: rgb(8, 8, 8); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;Channel&lt;/span&gt;&amp;gt;&lt;/b&gt;&amp;nbsp;futureChannel&lt;b&gt;&lt;span style=&quot;background-color: rgb(255, 255, 255); color: rgb(8, 8, 8); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;对象，&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;注意这个get(), 是执行SettableFuture&lt;/span&gt;&lt;span style=&quot;background-color: rgb(255, 255, 255); color: rgb(8, 8, 8); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span style=&quot;background-color: initial; font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;Channel&lt;/span&gt;&lt;span style=&quot;background-color: rgb(255, 255, 255); color: rgb(8, 8, 8); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;&amp;gt; get(),&amp;nbsp;&lt;/span&gt;SettableFuture是参考FutureTask编写的，旨在等待applicationLayer层面的channel建立（当调用&lt;/b&gt;futureChannel&lt;span style=&quot;background-color: rgb(255, 255, 255); color: rgb(8, 8, 8); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;.set(&lt;/span&gt;&lt;span style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt; color: rgb(135, 16, 148);&quot;&gt;channel）时，这个等待结束&lt;/span&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;）（它和socketChannel不是一个意思，socketChannel是socket层面的channel; 而此处的Channel是在socketChannel建立连接，并且完成认证等交互并且收到指定的capabiliity定义后才生成Channel对象(应用层层面的Channel)）&lt;br&gt;&lt;/b&gt;；&lt;br&gt;&lt;br&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-1900" y="610" width="810" height="120" as="geometry" />
        </mxCell>
        <mxCell id="1UW1yn8sc5tRWC661rli-1" value="" style="endArrow=none;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-1060" y="5560" as="sourcePoint" />
            <mxPoint x="-1060" y="2120.769230769231" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="1UW1yn8sc5tRWC661rli-2" value="" style="endArrow=none;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="46.73000000000002" y="5469.23" as="sourcePoint" />
            <mxPoint x="46.73000000000002" y="2419.999230769231" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="1UW1yn8sc5tRWC661rli-3" value="" style="endArrow=none;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="2040" y="5649.23" as="sourcePoint" />
            <mxPoint x="2040" y="2599.999230769231" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="1UW1yn8sc5tRWC661rli-4" value="" style="endArrow=none;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="2950" y="5489.23" as="sourcePoint" />
            <mxPoint x="2950" y="2439.999230769231" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="1UW1yn8sc5tRWC661rli-5" value="" style="endArrow=none;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="3770" y="5489.23" as="sourcePoint" />
            <mxPoint x="3770" y="2439.999230769231" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="gOw527kXX3alILfFZIPG-1" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;onRead(&lt;span style=&quot;color:#000000;&quot;&gt;ByteBuffer &lt;/span&gt;data)&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="-1596.75" y="3480" width="297" height="40" as="geometry" />
        </mxCell>
        <mxCell id="gOw527kXX3alILfFZIPG-2" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;onRecv(&lt;span style=&quot;color:#000000;&quot;&gt;ByteBuffer &lt;/span&gt;data)&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="-1545" y="3380" width="225" height="60" as="geometry" />
        </mxCell>
        <mxCell id="gOw527kXX3alILfFZIPG-3" value="" style="endArrow=classic;html=1;rounded=0;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-1446.75" y="3425" as="sourcePoint" />
            <mxPoint x="-1446.75" y="3485" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="gOw527kXX3alILfFZIPG-4" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;transport = &lt;span style=&quot;color:#0033b3;&quot;&gt;new &lt;/span&gt;ByteBufferCommandTransport(&lt;span style=&quot;color:#000000;&quot;&gt;remoteCapability&lt;/span&gt;);&lt;/pre&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;br&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;br&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="-1620" y="3610" width="500" as="geometry" />
        </mxCell>
        <mxCell id="gOw527kXX3alILfFZIPG-5" value="如果收到capability对象" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="-1740" y="3390" width="150" height="30" as="geometry" />
        </mxCell>
        <mxCell id="gOw527kXX3alILfFZIPG-6" value="" style="endArrow=classic;html=1;rounded=0;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-1446.75" y="3507" as="sourcePoint" />
            <mxPoint x="-1446.75" y="3567" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="gOw527kXX3alILfFZIPG-7" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;listener=JnlpProtocol4Handler#Handler&lt;/pre&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;listener.decorate(channelBuilder&lt;span style=&quot;font-size: 9.8pt;&quot;&gt;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="-2082.25" y="3630" width="440" height="50" as="geometry" />
        </mxCell>
        <mxCell id="gOw527kXX3alILfFZIPG-8" value="&lt;pre style=&quot;border-color: var(--border-color); background-color: rgb(255, 255, 255); color: rgb(8, 8, 8); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;channel = channelBuilder.build(transport)&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="-1400.75" y="3650" width="367" height="30" as="geometry" />
        </mxCell>
        <mxCell id="gOw527kXX3alILfFZIPG-9" value="" style="endArrow=classic;html=1;rounded=0;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-1448.75" y="3610" as="sourcePoint" />
            <mxPoint x="-1448.75" y="3650" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="gOw527kXX3alILfFZIPG-10" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;lifecycle = &lt;span style=&quot;color:#000000;&quot;&gt;State&lt;/span&gt;.&lt;span style=&quot;color:#871094;font-style:italic;&quot;&gt;BEFORE_CHANNEL&lt;/span&gt;;&lt;span style=&quot;color:#008dde;font-style:italic;&quot;&gt;&lt;br&gt;&lt;/span&gt;jnlp4ConnectionState.fire(&lt;span style=&quot;color:#000000;&quot;&gt;JnlpConnectionStateListener&lt;/span&gt;::beforeChannel);&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="-2008.75" y="3760" width="412" height="40" as="geometry" />
        </mxCell>
        <mxCell id="gOw527kXX3alILfFZIPG-11" value="" style="endArrow=classic;html=1;rounded=0;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-1874" y="3680" as="sourcePoint" />
            <mxPoint x="-1874" y="3710" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="gOw527kXX3alILfFZIPG-12" value="" style="endArrow=classic;html=1;rounded=0;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-1871.25" y="3740" as="sourcePoint" />
            <mxPoint x="-1871.25" y="3770" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="gOw527kXX3alILfFZIPG-13" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;pre style=&quot;border-color: var(--border-color); text-align: left; font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;jnlp4ConnectionState.fireBeforeChannel(&lt;span style=&quot;font-size: 9.8pt; text-align: center; color: rgb(0, 0, 0);&quot;&gt;ChannelBuilder&lt;/span&gt;&lt;span style=&quot;font-size: 9.8pt; text-align: center;&quot;&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="-2020" y="3710" width="416" height="30" as="geometry" />
        </mxCell>
        <mxCell id="gOw527kXX3alILfFZIPG-14" value="listener=Engine#EngineJnlpConnectionStateListener&lt;br style=&quot;border-color: var(--border-color);&quot;&gt;listerner.&amp;nbsp;beforeChannel&lt;span style=&quot;background-color: initial;&quot;&gt;(jnlp4ConnectionState&lt;/span&gt;&lt;span style=&quot;background-color: initial; border-color: var(--border-color);&quot;&gt;)&lt;/span&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="-1984" y="3830" width="270" height="30" as="geometry" />
        </mxCell>
        <mxCell id="gOw527kXX3alILfFZIPG-15" value="" style="endArrow=classic;html=1;rounded=0;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-1869.5" y="3800" as="sourcePoint" />
            <mxPoint x="-1869.5" y="3830" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="gOw527kXX3alILfFZIPG-16" value="" style="endArrow=classic;html=1;rounded=0;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-1866.5" y="3867.25" as="sourcePoint" />
            <mxPoint x="-1865.75" y="3922.75" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="gOw527kXX3alILfFZIPG-17" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;channdelBuilder.withJarCache(&lt;span style=&quot;color:#871094;&quot;&gt;jarCache&lt;/span&gt;);&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="-1850" y="3910" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="gOw527kXX3alILfFZIPG-18" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;listener=JnlpProtocol4Handler#Handler&lt;/pre&gt;&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;listener.onChannel(channel&lt;span style=&quot;font-size: 9.8pt;&quot;&gt;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="-1460" y="3720" width="440" height="50" as="geometry" />
        </mxCell>
        <mxCell id="gOw527kXX3alILfFZIPG-19" value="" style="endArrow=classic;html=1;rounded=0;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-1246.75" y="3680" as="sourcePoint" />
            <mxPoint x="-1246.75" y="3710" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="gOw527kXX3alILfFZIPG-20" value="" style="endArrow=classic;html=1;rounded=0;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-1253.87" y="3780" as="sourcePoint" />
            <mxPoint x="-1253.87" y="3810" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="gOw527kXX3alILfFZIPG-21" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;channel.addListener(listener);&lt;br&gt;&lt;span style=&quot;color:#871094;&quot;&gt;threadPool&lt;/span&gt;.execute(() -&amp;gt; {&lt;br&gt;    &lt;span style=&quot;color:#0033b3;&quot;&gt;if &lt;/span&gt;(!&lt;span style=&quot;color:#851691;&quot;&gt;channel&lt;/span&gt;.isClosingOrClosed()) {&lt;br&gt;        jnlp4ConnectionState.fireAfterChannel(channel&lt;span style=&quot;font-size: 9.8pt;&quot;&gt;);&lt;/span&gt;&lt;br&gt;    }&lt;br&gt;});&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="-1503.3700000000001" y="3820" width="413.37" height="100" as="geometry" />
        </mxCell>
        <mxCell id="gOw527kXX3alILfFZIPG-22" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;lifecycle = &lt;span style=&quot;color:#000000;&quot;&gt;State&lt;/span&gt;.&lt;span style=&quot;color:#871094;font-style:italic;&quot;&gt;AFTER_CHANNEL&lt;/span&gt;;&lt;br&gt;&lt;span style=&quot;color:#0033b3;&quot;&gt;this&lt;/span&gt;.&lt;span style=&quot;color:#871094;&quot;&gt;channelBuilder &lt;/span&gt;= &lt;span style=&quot;color:#0033b3;&quot;&gt;null&lt;/span&gt;;&lt;br&gt;&lt;span style=&quot;color:#0033b3;&quot;&gt;this&lt;/span&gt;.&lt;span style=&quot;color:#871094;&quot;&gt;channel &lt;/span&gt;= channel;&lt;br&gt;jnlp4ConnectionState.fire(&lt;span style=&quot;color:#000000;&quot;&gt;JnlpConnectionStateListener&lt;/span&gt;::afterChannel);&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="-1591.75" y="3970" width="490" height="65" as="geometry" />
        </mxCell>
        <mxCell id="gOw527kXX3alILfFZIPG-23" value="" style="endArrow=classic;html=1;rounded=0;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-1253.87" y="3920" as="sourcePoint" />
            <mxPoint x="-1253.87" y="3960" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="gOw527kXX3alILfFZIPG-24" value="listener=Engine#EngineJnlpConnectionStateListener&lt;br style=&quot;border-color: var(--border-color);&quot;&gt;listerner.&amp;nbsp;afterChannel&lt;span style=&quot;background-color: initial;&quot;&gt;(jnlp4ConnectionState&lt;/span&gt;&lt;span style=&quot;background-color: initial; border-color: var(--border-color);&quot;&gt;)&lt;/span&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="-1481.75" y="4060" width="270" height="30" as="geometry" />
        </mxCell>
        <mxCell id="gOw527kXX3alILfFZIPG-25" value="" style="endArrow=classic;html=1;rounded=0;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-1299.75" y="4030" as="sourcePoint" />
            <mxPoint x="-1299.75" y="4060" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="gOw527kXX3alILfFZIPG-26" value="用线程池运行，但是似乎并没做耗时的事？" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="-1240" y="3920" width="130" height="30" as="geometry" />
        </mxCell>
        <mxCell id="gOw527kXX3alILfFZIPG-27" value="" style="shape=link;html=1;rounded=0;edgeStyle=orthogonalEdgeStyle;" edge="1" parent="1">
          <mxGeometry width="100" relative="1" as="geometry">
            <mxPoint x="-2082.25" y="5030" as="sourcePoint" />
            <mxPoint x="4948.09" y="5043" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="gOw527kXX3alILfFZIPG-28" value="Channel创建在ApplicationLayer层" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="-1866.5" y="5130" width="190" height="40" as="geometry" />
        </mxCell>
        <mxCell id="gOw527kXX3alILfFZIPG-29" value="&lt;pre style=&quot;background-color: rgb(255, 255, 255); font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;&lt;span style=&quot;color: rgb(8, 8, 8);&quot;&gt;channel = new Channel(&lt;/span&gt;&lt;font color=&quot;#0033b3&quot;&gt;ChannelBuild&lt;/font&gt;&lt;font color=&quot;#080808&quot;&gt;,transport)&lt;/font&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="-1629.25" y="5130" width="359.25" height="40" as="geometry" />
        </mxCell>
        <mxCell id="gOw527kXX3alILfFZIPG-30" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;transport = &lt;span style=&quot;color:#0033b3;&quot;&gt;new &lt;/span&gt;ByteBufferCommandTransport(&lt;span style=&quot;color:#000000;&quot;&gt;remoteCapability&lt;/span&gt;);&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="-1620" y="5050" width="462" height="30" as="geometry" />
        </mxCell>
        <mxCell id="gOw527kXX3alILfFZIPG-31" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;ChannelBuilder builder = &lt;span style=&quot;color:#0033b3;&quot;&gt;new &lt;/span&gt;ChannelBuilder(stack().name(), &lt;span style=&quot;color:#871094;&quot;&gt;executorService&lt;/span&gt;)&lt;br&gt;        .withMode(&lt;span style=&quot;color:#000000;&quot;&gt;Channel&lt;/span&gt;.&lt;span style=&quot;color:#000000;&quot;&gt;Mode&lt;/span&gt;.&lt;span style=&quot;color:#871094;font-style:italic;&quot;&gt;BINARY&lt;/span&gt;);&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="-1545" y="5090" width="442" height="30" as="geometry" />
        </mxCell>
        <mxCell id="gOw527kXX3alILfFZIPG-32" value="&lt;pre style=&quot;background-color:#ffffff;color:#080808;font-family:&#39;JetBrains Mono&#39;,monospace;font-size:9.8pt;&quot;&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;&lt;br&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;transport.setup(channel, &lt;span style=&quot;color:#0033b3;&quot;&gt;new &lt;/span&gt;&lt;span style=&quot;color:#000000;&quot;&gt;CommandReceiver&lt;/span&gt;() {&lt;br&gt;    &lt;span style=&quot;color:#9e880d;&quot;&gt;@Override&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color:#9e880d;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color:#0033b3;&quot;&gt;public void &lt;/span&gt;&lt;span style=&quot;color:#00627a;&quot;&gt;handle&lt;/span&gt;(&lt;span style=&quot;color:#000000;&quot;&gt;Command &lt;/span&gt;cmd) {&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;        cmd.execute(channel);&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;    }&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;    @Override&lt;br&gt;&lt;span style=&quot;color:#0033b3;&quot;&gt;    public void &lt;/span&gt;&lt;span style=&quot;color:#00627a;&quot;&gt;terminate&lt;/span&gt;(&lt;span style=&quot;color:#000000;&quot;&gt;IOException &lt;/span&gt;e) {&lt;br&gt;        &lt;span style=&quot;color:#000000;&quot;&gt;Channel&lt;/span&gt;.&lt;span style=&quot;color:#0033b3;&quot;&gt;this&lt;/span&gt;.terminate(e);&lt;br&gt;    }&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;}&lt;/pre&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="-1566.75" y="5280" width="391" height="100" as="geometry" />
        </mxCell>
        <mxCell id="gOw527kXX3alILfFZIPG-33" value="" style="endArrow=classic;html=1;rounded=0;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-1436.75" y="5180" as="sourcePoint" />
            <mxPoint x="-1436.75" y="5220" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="gOw527kXX3alILfFZIPG-34" value="创建channel时执行下面setup, 然后，channel中有transport，transport中有channel" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="-1410" y="5180" width="270" height="30" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
